<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Califonix Master Dashboard</title>
<!-- Libraries -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
  :root { --primary: #0d6efd; --bg: #f0f2f5; --text: #333; }
  body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
  .container { max-width: 1250px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
  
  /* Header */
  .header-box { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
  .logo { height: 55px; }
  
  /* Nav */
  .nav { display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex-wrap: wrap; }
  .nav-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; background: #e9ecef; color: #555; }
  .nav-btn:hover, .nav-btn.active { background: var(--primary); color: white; transform: translateY(-2px); }

  /* Forms & Cards */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 15px; }
  label { font-weight: 600; font-size: 13px; color: #555; display: block; margin-bottom: 5px; }
  input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  .section-card { background: #fff; border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
  
  /* Defect Table */
  .defect-row { display: grid; grid-template-columns: 2fr 1fr 1fr 0.8fr 2fr 1fr 0.5fr; gap: 10px; align-items: end; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #eee; }
  
  /* Top 3 Section Style */
  .top3-box { background: #f1f8ff; border: 1px dashed #0d6efd; padding: 20px; border-radius: 10px; margin-top: 20px; display: none; }
  .top3-grid { display: flex; gap: 20px; flex-wrap: wrap; }
  .top3-table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
  .top3-table th { background: #333; color: white; padding: 8px; text-align: left; }
  .top3-table td { border-bottom: 1px solid #ddd; padding: 8px; vertical-align: middle; }
  .action-input { border: 1px solid #28a745; background: #fafffb; }

  /* Buttons */
  .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; color: white; }
  .btn-red { background: #dc3545; } .btn-ai { background: linear-gradient(135deg, #6f42c1, #8e44ad); }
  .btn-main { width: 100%; padding: 15px; background: #0d6efd; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }

  /* KPIs */
  .kpi-row { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
  .kpi-card { flex: 1; min-width: 150px; background: white; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  .kpi-val { font-size: 24px; font-weight: 800; margin-top: 5px; }

  /* Charts & Reports */
  .chart-flex { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
  .chart-box { flex: 1; min-width: 350px; height: 350px; border: 1px solid #f0f0f0; padding: 10px; border-radius: 8px; }
  
  /* Modal */
  .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
  .modal-content { background: white; margin: 2% auto; padding: 0; width: 90%; max-width: 800px; border-radius: 10px; overflow: hidden; }
  .preview-header { background: #333; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
  .preview-body { padding: 30px; max-height: 70vh; overflow-y: auto; }
  .preview-footer { padding: 15px; background: #f8f9fa; text-align: right; border-top: 1px solid #eee; }
  
  /* Preview Document Style */
  .doc-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  .doc-table th { background: #f1f1f1; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; }
  .doc-table td { padding: 8px; border-bottom: 1px solid #eee; }
  .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
  .bg-rmd { background: #fff3cd; color: #856404; } .bg-proc { background: #f8d7da; color: #721c24; }

  #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; text-align: center; padding-top: 200px; font-size: 20px; font-weight: bold; color: var(--primary); }
</style>
</head>
<body>

<div id="loader">Processing... <i class="fas fa-spinner fa-spin"></i></div>

<div class="container">
  <!-- Header -->
  <div class="header-box">
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo" alt="Califonix">
      <div>
          <h3 style="margin:0; text-align:right;">Production & Quality System</h3>
          <small style="color:#777;">Smart Manufacturing Dashboard</small>
      </div>
  </div>

  <!-- Navigation -->
  <div class="nav">
    <button class="nav-btn active" onclick="switchTab(this, 'dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
    <button class="nav-btn" onclick="switchTab(this, 'entry')"><i class="fas fa-edit"></i> Data Entry</button>
    <button class="nav-btn" onclick="switchTab(this, 'report')"><i class="fas fa-file-alt"></i> Overall Report</button>
    <button class="nav-btn" onclick="switchTab(this, 'modelReport')"><i class="fas fa-cube"></i> Model Report</button>
  </div>

  <!-- 1. DASHBOARD TAB -->
  <div id="dashboard" class="tab-page">
      <div class="form-grid">
          <div><label>From Date</label><input type="date" id="d_from"></div>
          <div><label>To Date</label><input type="date" id="d_to"></div>
          <div style="display:flex; align-items:end;"><button class="btn-main" style="padding:10px;" onclick="loadData()">Filter</button></div>
      </div>

      <div class="kpi-row">
          <div class="kpi-card" style="border-color: #28a745;"><div>Total Production</div><div class="kpi-val" id="k_prod">0</div></div>
          <div class="kpi-card" style="border-color: #ffc107;"><div>RMD Rejection</div><div class="kpi-val" id="k_rmd" style="color:#b38600">0%</div></div>
          <div class="kpi-card" style="border-color: #dc3545;"><div>Process Rejection</div><div class="kpi-val" id="k_proc" style="color:#dc3545">0%</div></div>
      </div>

      <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; text-align:center; font-size:13px;">
              <thead>
                  <tr style="background:#333; color:white;">
                      <th style="padding:10px;">Date</th><th>Model</th><th>Input</th><th>RMD %</th><th>Proc %</th><th>Action</th>
                  </tr>
              </thead>
              <tbody id="dash_table"></tbody>
          </table>
      </div>
  </div>

  <!-- 2. DATA ENTRY TAB -->
  <div id="entry" class="tab-page" style="display:none;">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <h4 style="margin:0; color:var(--primary);">üìù New Production Record</h4>
          <button class="btn-sm" style="background:#6c757d;" onclick="resetForm()">Reset Form</button>
      </div>
      <input type="hidden" id="edit_index">

      <!-- Production Section -->
      <div class="section-card">
          <h5 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Production Details</h5>
          <div class="form-grid">
              <div><label>Date</label><input type="date" id="e_date"></div>
              <div><label>Line</label><select id="e_line"><option>Line 1</option><option>Line 2</option><option>Line 3</option></select></div>
              <div><label>Model Name</label><input type="text" id="e_model"></div>
              <div><label>Input Qty</label><input type="number" id="e_input" oninput="calcStats()"></div>
              <div><label>Prepared By</label><input type="text" id="e_prep"></div>
          </div>

          <label>Defect List:</label>
          <div id="defect_wrapper"></div>
          <button class="btn-sm" style="background:#555; margin-top:10px;" onclick="addDefectRow()">+ Add Defect</button>

          <div class="kpi-row" style="margin-top:15px; gap:10px;">
              <div style="flex:1; background:#fff3cd; padding:10px; border-radius:5px; text-align:center;">
                  <small>RMD Rejection</small><div id="disp_rmd" style="font-weight:bold; color:#856404;">0%</div>
              </div>
              <div style="flex:1; background:#f8d7da; padding:10px; border-radius:5px; text-align:center;">
                  <small>Process Rejection</small><div id="disp_proc" style="font-weight:bold; color:#721c24;">0%</div>
              </div>
          </div>
      </div>

      <!-- NEW TOP 3 SECTION (Aggregated) -->
      <div id="top3_container" class="top3-box">
          <h4 style="margin-top:0; color:#0d6efd;"><i class="fas fa-chart-pie"></i> Top 3 Defects & Action Plan (Aggregated)</h4>
          <div class="top3-grid">
              <div style="flex:1; min-width:300px; height:250px; background:white; padding:5px; border-radius:5px;" id="top3_chart"></div>
              <div style="flex:1.5; min-width:350px;">
                  <table class="top3-table">
                      <thead><tr><th>Rank</th><th>Defect</th><th>Total Qty</th><th>Rate %</th><th>Merged Analysis</th><th>Action Plan (Manual)</th></tr></thead>
                      <tbody id="top3_tbody"></tbody>
                  </table>
              </div>
          </div>
      </div>

      <button class="btn-main" style="margin-top:20px;" onclick="showPreview()">üëÅÔ∏è Preview & Submit</button>
  </div>

  <!-- 3. REPORT TAB -->
  <div id="report" class="tab-page" style="display:none;">
      <div class="form-grid no-print">
          <div><label>From</label><input type="date" id="r_from"></div>
          <div><label>To</label><input type="date" id="r_to"></div>
          <div style="display:flex; align-items:end; gap:10px;">
              <button class="btn-main" style="padding:10px;" onclick="genReport('overall')">Generate</button>
              <button class="btn-sm" style="background:#28a745; padding:12px;" onclick="dlPdf('rep_area', 'Overall_Report')">Download PDF</button>
          </div>
      </div>

      <div id="rep_area" style="display:none; padding:20px; border:1px solid #ddd; margin-top:20px;">
          <h2 style="text-align:center; border-bottom:2px solid #333; padding-bottom:10px;">OVERALL QUALITY REPORT</h2>
          <p style="text-align:center;"><b>Period:</b> <span id="r_period"></span></p>

          <table style="width:100%; border:1px solid #ddd; margin-bottom:20px; text-align:center;">
              <tr style="background:#f8f9fa;">
                  <td style="padding:10px;"><b>Total Production:</b> <br><span id="r_inp">0</span></td>
                  <td style="padding:10px;"><b>Total Defects:</b> <br><span id="r_def">0</span></td>
                  <td style="padding:10px;"><b>Avg Process Rej:</b> <br><span id="r_proc" style="color:red">0%</span></td>
              </tr>
          </table>

          <div class="chart-flex">
              <div class="chart-box" id="chart_trend"></div>
              <div class="chart-box" id="chart_pareto"></div>
          </div>
          
          <h4>üèÜ Top 5 Production Issues</h4>
          <div id="r_list"></div>
      </div>
  </div>

  <!-- 4. MODEL REPORT TAB -->
  <div id="modelReport" class="tab-page" style="display:none;">
      <div class="form-grid no-print">
          <div><label>From</label><input type="date" id="m_from"></div>
          <div><label>To</label><input type="date" id="m_to"></div>
          <div><label>Model</label><select id="m_select"><option>Loading...</option></select></div>
          <div style="display:flex; align-items:end; gap:10px;">
              <button class="btn-main" style="padding:10px; background:#6f42c1;" onclick="genReport('model')">View</button>
              <button class="btn-sm" style="background:#28a745; padding:12px;" onclick="dlPdf('mod_area', 'Model_Report')">PDF</button>
          </div>
      </div>
      
      <div id="mod_area" style="display:none; padding:20px; border:1px solid #ddd; margin-top:20px;">
          <h2 style="text-align:center; border-bottom:2px solid #6f42c1; padding-bottom:10px; color:#6f42c1;">MODEL WISE REPORT</h2>
          <h3 style="text-align:center;" id="m_title"></h3>
          <div class="chart-flex">
              <div class="chart-box" id="m_trend"></div>
              <div class="chart-box" id="m_pareto"></div>
          </div>
          <div id="m_list"></div>
      </div>
  </div>

</div>

<!-- PREVIEW MODAL -->
<div id="prevModal" class="modal">
    <div class="modal-content">
        <div class="preview-header">
            <h4 style="margin:0;">üìÑ Confirm Submission</h4>
            <span style="cursor:pointer; font-size:20px;" onclick="closeModal()">‚úñ</span>
        </div>
        <div class="preview-body" id="prevBody">
            <!-- Dynamic Content -->
        </div>
        <div class="preview-footer">
            <button class="btn-sm" style="background:#6c757d; font-size:14px; padding:10px 20px;" onclick="closeModal()">Edit</button>
            <button class="btn-sm" style="background:#28a745; font-size:14px; padding:10px 20px;" onclick="saveData()">‚úÖ Final Submit</button>
        </div>
    </div>
</div>

<script>
// ==========================================
// CONFIGURATION
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbzEQnAWeU_bKs0T8CTwLLBYcgtRuS1ppDc47VvxLOLtjxhOZDTmf8qoYrUJfQttAVkO5Q/exec"; // üî¥ ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ URL ‡§°‡§æ‡§≤‡•á‡§Ç
const GEMINI_API_KEY = "AIzaSyDwFbj25ROQX52IzObhVIW_6t61O5TC2pA"; 

let allData = [];
// Store Action Plans temporarily while typing
let actionPlanMap = {}; 
let top3Chart = null; // Store chart instance for preview

google.charts.load('current', {'packages':['corechart']});

window.onload = () => {
    document.getElementById('e_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('d_from').value = new Date().toISOString().split('T')[0];
    loadData();
    addDefectRow();
};

function switchTab(btn, id){
    document.querySelectorAll('.tab-page').forEach(d => d.style.display='none');
    document.getElementById(id).style.display='block';
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// ==========================================
// DATA ENTRY LOGIC
// ==========================================
function addDefectRow(data=null){
    const div = document.createElement('div');
    div.className = 'defect-row';
    div.innerHTML = `
        <div><label>Defect Name</label><input type="text" class="d-name" placeholder="Name" oninput="calcStats()"></div>
        <div><label>Type</label><select class="d-type" onchange="calcStats()"><option>Process</option><option>RMD</option></select></div>
        <div><label>Qty</label><input type="number" class="d-qty" oninput="calcStats()" value="0"></div>
        <div><label>Rate %</label><input type="text" class="d-rate" readonly style="background:#eee; font-weight:bold; text-align:center;"></div>
        <div><label>Analysis</label><div style="display:flex;"><input class="d-ana" oninput="calcStats()"><button class="btn-sm btn-ai" onclick="aiFix(this)">AI</button></div></div>
        <div><label>Img</label><input type="file" accept="image/*"></div>
        <div><label>&nbsp;</label><button class="btn-red btn-sm" onclick="this.closest('.defect-row').remove(); calcStats()">X</button></div>
    `;
    document.getElementById('defect_wrapper').appendChild(div);
    if(data){
        div.querySelector('.d-name').value = data.name;
        div.querySelector('.d-type').value = data.type;
        div.querySelector('.d-qty').value = data.qty;
        div.querySelector('.d-ana').value = data.ana;
        if(data.action) actionPlanMap[data.name] = data.action;
    }
}

function calcStats(){
    let inp = +document.getElementById('e_input').value || 0;
    let rmdSum = 0, procSum = 0;
    let defectList = [];
    
    document.querySelectorAll('.defect-row').forEach(row => {
        let name = row.querySelector('.d-name').value;
        let q = +row.querySelector('.d-qty').value || 0;
        let t = row.querySelector('.d-type').value;
        let ana = row.querySelector('.d-ana').value;
        
        let rate = inp ? ((q/inp)*100).toFixed(2)+"%" : "0%";
        row.querySelector('.d-rate').value = rate;

        if(q > 0 && name) {
            defectList.push({ name, qty: q, ana, type:t });
        }

        if(t === 'RMD') rmdSum += q; else procSum += q;
    });
    
    document.getElementById('disp_rmd').innerText = inp ? ((rmdSum/inp)*100).toFixed(2)+"%" : "0%";
    document.getElementById('disp_proc').innerText = inp ? ((procSum/inp)*100).toFixed(2)+"%" : "0%";
    
    renderTop3(defectList, inp);

    return { rmdSum, procSum, rmdRate: document.getElementById('disp_rmd').innerText, procRate: document.getElementById('disp_proc').innerText, defectList };
}

// ==========================================
// TOP 3 RENDER LOGIC (CATEGORIZED ANALYSIS)
// ==========================================
function updateActionMap(input, defName) {
    actionPlanMap[defName] = input.value;
}

function renderTop3(list, totalInput) {
    let container = document.getElementById('top3_container');
    if(list.length === 0) { container.style.display = 'none'; return; }
    container.style.display = 'block';

    // 1. AGGREGATE SAME DEFECTS & SPLIT ANALYSIS
    let grouped = {};
    list.forEach(d => {
        let key = d.name.trim().toLowerCase();
        if(!key) return;
        
        if(!grouped[key]) {
            grouped[key] = { 
                name: d.name, 
                qty: 0, 
                procAna: [], 
                rmdAna: [] 
            }; 
        }
        
        grouped[key].qty += +d.qty;
        
        // Categorize Analysis
        if(d.ana && d.ana.trim() !== "") {
            if(d.type === 'Process') {
                if(!grouped[key].procAna.includes(d.ana)) grouped[key].procAna.push(d.ana);
            } else {
                if(!grouped[key].rmdAna.includes(d.ana)) grouped[key].rmdAna.push(d.ana);
            }
        }
    });

    // 2. FORMAT DATA FOR DISPLAY
    let aggregatedList = Object.values(grouped);
    aggregatedList.forEach(d => {
        d.rate = totalInput ? ((d.qty / totalInput) * 100).toFixed(2) + "%" : "0%";
        
        // Build the formatted string
        let anaHtml = "";
        if(d.procAna.length > 0) anaHtml += `<b>Process :-</b> ${d.procAna.join(', ')}`;
        if(d.rmdAna.length > 0) {
            if(anaHtml) anaHtml += "<br>";
            anaHtml += `<b>RMD :-</b> ${d.rmdAna.join(', ')}`;
        }
        d.displayAna = anaHtml || "-";
    });

    aggregatedList.sort((a,b) => b.qty - a.qty);
    let top3 = aggregatedList.slice(0, 3);

    // 3. DRAW CHART
    let chartData = [['Defect', 'Total Qty', { role: 'style' }]];
    let colors = ['#dc3545', '#fd7e14', '#ffc107'];
    top3.forEach((d, i) => {
        chartData.push([d.name, d.qty, colors[i] || '#0d6efd']);
    });
    
    top3Chart = new google.visualization.ColumnChart(document.getElementById('top3_chart'));
    top3Chart.draw(google.visualization.arrayToDataTable(chartData), {
        title: 'Top 3 Defects (Aggregated)',
        legend: { position: "none" },
        chartArea: {width:'80%', height:'70%'},
        vAxis: { minValue: 0 }
    });

    // 4. RENDER TABLE
    let tbody = document.getElementById('top3_tbody');
    tbody.innerHTML = "";
    
    top3.forEach((d, i) => {
        let existingAction = actionPlanMap[d.name] || "";
        tbody.innerHTML += `
            <tr>
                <td><span class="badge" style="background:#333; color:white;">#${i+1}</span></td>
                <td><b>${d.name}</b></td>
                <td>${d.qty}</td>
                <td style="color:red; font-weight:bold;">${d.rate}</td>
                <td style="font-size:12px;">${d.displayAna}</td>
                <td><input type="text" class="action-input" placeholder="Enter Action Plan..." 
                    value="${existingAction}" oninput="updateActionMap(this, '${d.name}')">
                </td>
            </tr>
        `;
    });
}

// ==========================================
// AI & PREVIEW (UPDATED WITH SPLIT ANALYSIS)
// ==========================================
async function aiFix(btn) {
    let txt = btn.previousElementSibling.value;
    if(!txt) return alert("Enter text first!");
    btn.innerText = "‚è≥";
    try {
        let res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: "Fix grammar and make concise: " + txt }] }] })
        });
        let j = await res.json();
        btn.previousElementSibling.value = j.candidates[0].content.parts[0].text;
        calcStats();
    } catch(e) { alert("AI Error"); }
    btn.innerText = "AI";
}

function showPreview() {
    let stats = calcStats();
    let d = {
        date: document.getElementById('e_date').value,
        line: document.getElementById('e_line').value,
        model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value,
        rmdRate: stats.rmdRate,
        procRate: stats.procRate
    };

    // 1. RE-CALCULATE AGGREGATED TOP 3 FOR PREVIEW
    let defectList = stats.defectList; 
    let grouped = {};
    defectList.forEach(item => {
        let key = item.name.trim().toLowerCase();
        if(!grouped[key]) {
            grouped[key] = { 
                name: item.name, 
                qty: 0,
                procAna: [],
                rmdAna: []
            }; 
        }
        grouped[key].qty += item.qty;
        
        if(item.ana && item.ana.trim() !== "") {
            if(item.type === 'Process') {
                if(!grouped[key].procAna.includes(item.ana)) grouped[key].procAna.push(item.ana);
            } else {
                if(!grouped[key].rmdAna.includes(item.ana)) grouped[key].rmdAna.push(item.ana);
            }
        }
    });

    let aggregated = Object.values(grouped).sort((a,b)=>b.qty - a.qty).slice(0,3);

    // 2. GENERATE TOP 3 TABLE HTML
    let top3Rows = "";
    aggregated.forEach((item, i) => {
        let rate = d.input ? ((item.qty / d.input) * 100).toFixed(2) + "%" : "0%";
        let act = actionPlanMap[item.name] || "<i>Pending...</i>";
        
        // Build Display Analysis
        let anaHtml = "";
        if(item.procAna.length > 0) anaHtml += `<b>Process :-</b> ${item.procAna.join(', ')}`;
        if(item.rmdAna.length > 0) {
            if(anaHtml) anaHtml += "<br>";
            anaHtml += `<b>RMD :-</b> ${item.rmdAna.join(', ')}`;
        }
        if(!anaHtml) anaHtml = "-";

        top3Rows += `
            <tr style="background:#fffcf5;">
                <td>#${i+1}</td>
                <td><b>${item.name}</b></td>
                <td>${item.qty}</td>
                <td style="color:red;">${rate}</td>
                <td style="font-size:12px;">${anaHtml}</td>
                <td style="color:green; font-weight:bold;">${act}</td>
            </tr>
        `;
    });

    // 3. GET CHART IMAGE
    let chartImg = (top3Chart && aggregated.length > 0) 
        ? `<div style="text-align:center; margin:20px 0; border:1px solid #eee; padding:10px;"><img src="${top3Chart.getImageURI()}" style="width:100%; max-width:500px;"></div>` 
        : "";

    // 4. MAIN PREVIEW HTML
    let html = `
        <div style="display:flex; align-items:center; border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:15px;">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px; margin-right:15px;">
            <div><h3 style="margin:0; color:#007bff;">Production Report</h3><small>${d.date}</small></div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div>
                <p><b>Line:</b> ${d.line}</p>
                <p><b>Model:</b> ${d.model}</p>
                <p><b>Input:</b> ${d.input}</p>
            </div>
            <div style="text-align:right;">
                <p style="color:#856404;"><b>RMD Rej:</b> ${d.rmdRate}</p>
                <p style="color:#721c24;"><b>Proc Rej:</b> ${d.procRate}</p>
            </div>
        </div>

        ${aggregated.length > 0 ? `
            <div style="background:#f1f8ff; padding:15px; border-radius:8px; border:1px dashed #007bff; margin-bottom:20px;">
                <h4 style="margin-top:0; color:#0d6efd; border-bottom:1px solid #cce5ff; padding-bottom:5px;">üèÜ Top 3 Defects & Action Plan</h4>
                ${chartImg}
                <table class="doc-table">
                    <thead style="background:#e7f1ff;"><tr><th>Rank</th><th>Defect</th><th>Tot Qty</th><th>Rate</th><th>Analysis</th><th>Action Plan</th></tr></thead>
                    <tbody>${top3Rows}</tbody>
                </table>
            </div>
        ` : ''}

        <h5 style="border-bottom:1px solid #ddd; padding-bottom:5px;">Full Defect List</h5>
        <table class="doc-table">
            <thead><tr><th>Defect</th><th>Type</th><th>Qty</th><th>Rate %</th><th>Analysis</th></tr></thead>
            <tbody>
    `;

    document.querySelectorAll('.defect-row').forEach(r => {
        let name = r.querySelector('.d-name').value;
        let qty = r.querySelector('.d-qty').value;
        let type = r.querySelector('.d-type').value;
        let rate = r.querySelector('.d-rate').value;
        let ana = r.querySelector('.d-ana').value;
        let cls = type === 'RMD' ? 'bg-rmd' : 'bg-proc';
        
        html += `<tr>
            <td>${name}</td>
            <td><span class="badge ${cls}">${type}</span></td>
            <td>${qty}</td>
            <td>${rate}</td>
            <td>${ana}</td>
        </tr>`;
    });

    html += `</tbody></table>`;
    
    document.getElementById('prevBody').innerHTML = html;
    document.getElementById('prevModal').style.display = "block";
}
function closeModal() { document.getElementById('prevModal').style.display = "none"; }

async function saveData() {
    document.getElementById('loader').style.display='block'; closeModal();
    let stats = calcStats();
    let defects = [];
    
    document.querySelectorAll('.defect-row').forEach(r => {
        let name = r.querySelector('.d-name').value;
        defects.push({ 
            name: name, 
            type: r.querySelector('.d-type').value, 
            qty: r.querySelector('.d-qty').value, 
            ana: r.querySelector('.d-ana').value,
            action: actionPlanMap[name] || "" 
        });
    });

    let payload = {
        action: 'save',
        rowIndex: document.getElementById('edit_index').value,
        date: document.getElementById('e_date').value,
        line: document.getElementById('e_line').value,
        model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value,
        totalDef: stats.rmdSum + stats.procSum,
        rmdRate: stats.rmdRate,
        procRate: stats.procRate,
        prep: document.getElementById('e_prep').value,
        defects: defects
    };

    try {
        await fetch(API_URL, { method:'POST', body:JSON.stringify(payload) });
        alert("Saved!"); location.reload();
    } catch(e) { alert("Error"); }
    document.getElementById('loader').style.display='none';
}

// ==========================================
// DASHBOARD & REPORTS
// ==========================================
async function loadData() {
    let res = await fetch(API_URL);
    let j = await res.json();
    allData = j.data;
    
    let tbody = document.getElementById('dash_table');
    tbody.innerHTML = "";
    let kpi = { prod:0, rmdD:0, procD:0 };
    let models = new Set();

    allData.forEach((r, i) => {
        if(r[0] < document.getElementById('d_from').value) return;
        
        let inp = +r[3]||0;
        kpi.prod += inp;
        
        let rmdR = parseFloat(r[5])||0; let procR = parseFloat(r[6])||0;
        kpi.rmdD += (inp * rmdR / 100);
        kpi.procD += (inp * procR / 100);
        models.add(r[2]);

        tbody.innerHTML += `<tr>
            <td>${r[0]}</td><td>${r[2]}</td><td>${inp}</td>
            <td style="color:#b38600">${r[5]}</td><td style="color:#dc3545">${r[6]}</td>
            <td><button class="btn-sm" style="background:#17a2b8" onclick='edit(${i}, ${JSON.stringify(r)})'>Edit</button></td>
        </tr>`;
    });

    document.getElementById('k_prod').innerText = kpi.prod;
    document.getElementById('k_rmd').innerText = kpi.prod ? (kpi.rmdD/kpi.prod*100).toFixed(2)+"%" : "0%";
    document.getElementById('k_proc').innerText = kpi.prod ? (kpi.procD/kpi.prod*100).toFixed(2)+"%" : "0%";

    let sel = document.getElementById('m_select');
    sel.innerHTML = "";
    models.forEach(m => sel.innerHTML += `<option>${m}</option>`);
}

function edit(i, r) {
    switchTab(document.querySelector("button[onclick*='entry']"), 'entry');
    document.getElementById('edit_index').value = i;
    document.getElementById('e_date').value = r[0];
    document.getElementById('e_line').value = r[1];
    document.getElementById('e_model').value = r[2];
    document.getElementById('e_input').value = r[3];
    document.getElementById('e_prep').value = r[7];
    
    document.getElementById('defect_wrapper').innerHTML = "";
    actionPlanMap = {}; 
    try { 
        JSON.parse(r[8]).forEach(d => addDefectRow(d)); 
    } catch(e){}
    calcStats();
}

function genReport(mode) {
    let area = mode === 'overall' ? 'rep_area' : 'mod_area';
    let from = document.getElementById(mode==='overall'?'r_from':'m_from').value;
    let targetModel = mode === 'model' ? document.getElementById('m_select').value : null;
    
    document.getElementById(area).style.display = 'block';
    
    let filtered = allData.filter(r => r[0] >= from && (!targetModel || r[2] === targetModel));
    
    let totIn=0, totDef=0;
    let dateMap = {}, defectMap = {};

    filtered.forEach(r => {
        let inp = +r[3]||0; totIn += inp; totDef += (+r[4]||0);
        let d = r[0];
        if(!dateMap[d]) dateMap[d] = {i:0, d:0};
        dateMap[d].i += inp; dateMap[d].d += (+r[4]||0);

        try { JSON.parse(r[8]).forEach(x => {
            defectMap[x.name] = (defectMap[x.name]||0) + (+x.qty);
        }); } catch(e){}
    });

    if(mode === 'overall') {
        document.getElementById('r_inp').innerText = totIn;
        document.getElementById('r_def').innerText = totDef;
        document.getElementById('r_proc').innerText = totIn ? (totDef/totIn*100).toFixed(2)+"%" : "0%";
        drawTrend(dateMap, 'chart_trend');
        drawPareto(defectMap, 'chart_pareto');
        listTopDefects(defectMap, 'r_list', totIn);
    } else {
        document.getElementById('m_title').innerText = targetModel;
        drawTrend(dateMap, 'm_trend');
        drawPareto(defectMap, 'm_pareto');
        listTopDefects(defectMap, 'm_list', totIn);
    }
}

function drawTrend(map, id) {
    let data = [['Date', 'Rejection %']];
    Object.keys(map).sort().forEach(d => {
        let r = map[d].i ? (map[d].d/map[d].i*100) : 0;
        data.push([d, r]);
    });
    new google.visualization.LineChart(document.getElementById(id)).draw(google.visualization.arrayToDataTable(data), {title:'Rejection Trend', legend:{position:'bottom'}});
}

function drawPareto(map, id) {
    let sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
    let data = [['Defect', 'Qty']];
    sorted.forEach(x => data.push(x));
    new google.visualization.ColumnChart(document.getElementById(id)).draw(google.visualization.arrayToDataTable(data), {title:'Top Defects', legend:'none'});
}

function listTopDefects(map, id, totalInput) {
    let sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
    let html = "<table style='width:100%; border:1px solid #ddd; margin-top:10px;'><tr><th>Defect</th><th>Qty</th><th>Contrib %</th></tr>";
    sorted.forEach(x => {
        let rate = totalInput ? (x[1]/totalInput*100).toFixed(2)+"%" : "0%";
        html += `<tr><td>${x[0]}</td><td>${x[1]}</td><td>${rate}</td></tr>`;
    });
    document.getElementById(id).innerHTML = html + "</table>";
}

function dlPdf(id, name) {
    const el = document.getElementById(id);
    html2pdf().set({margin:0.2, filename:name+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter', orientation:'portrait'}}).from(el).save();
}
function resetForm() { document.getElementById('edit_index').value=""; document.getElementById('defect_wrapper').innerHTML=""; actionPlanMap={}; addDefectRow(); }
</script>
</body>
</html>

