<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Dashcam Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .section-head { background: #e9ecef; border-left: 5px solid #0d6efd; padding: 10px; font-weight: bold; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none; }
        .chart-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .draft-badge { font-size: 0.8em; background: #ffc107; padding: 2px 5px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white shadow-sm px-4">
    <div class="d-flex align-items-center">
        <img id="navLogo" src="" style="height: 50px;" class="me-3">
        <h4 class="text-primary fw-bold mb-0">Dashcam Report</h4>
    </div>
    <ul class="nav nav-pills">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#entryTab">üìù Data Entry</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dashTab" onclick="loadDashboard()">üìä Dashboard</a></li>
    </ul>
</nav>

<div class="container mt-4 pb-5 tab-content">

    <!-- === DATA ENTRY TAB === -->
    <div class="tab-pane fade show active" id="entryTab">
        <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-warning btn-sm" onclick="saveDraft()">üíæ Save Draft (Partial)</button>
            <span id="draftMsg" class="ms-2 text-success fw-bold hidden">Draft Saved!</span>
        </div>

        <form id="mainForm">
            <!-- 1. Production Info -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="section-head mt-0">1. Production & Defect Details</div>
                    <div class="row g-3">
                        <div class="col-md-3"><label>Date</label><input type="date" id="date" class="form-control"></div>
                        <div class="col-md-3"><label>Model</label><input type="text" id="model" class="form-control"></div>
                        <div class="col-md-3"><label>Colour</label><input type="text" id="colour" class="form-control"></div>
                        <div class="col-md-3"><label>Input Qty</label><input type="number" id="inputQty" class="form-control" oninput="calcRates()"></div>
                        
                        <div class="col-md-3"><label>FG Qty</label><input type="number" id="fgQty" class="form-control"></div>
                        <div class="col-md-3"><label>Total Defect Qty</label><input type="number" id="defectQty" class="form-control" readonly></div>
                        <div class="col-md-2"><label>RMD Rate %</label><input type="text" id="rmdRate" class="form-control text-primary fw-bold" readonly></div>
                        <div class="col-md-2"><label>Process Rate %</label><input type="text" id="procRate" class="form-control text-danger fw-bold" readonly></div>
                        <div class="col-md-2"><label>Total Defect %</label><input type="text" id="totalRate" class="form-control text-dark fw-bold" readonly></div>
                    </div>

                    <!-- Defect Bifurcation -->
                    <div class="mt-3">
                        <table class="table table-bordered table-sm" id="prodTable">
                            <thead class="table-light">
                                <tr><th>Defect Details</th><th>Qty</th><th>Type</th><th>Cause</th><th>Action</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProdRow()">+ Add Defect Row</button>
                    </div>
                </div>
            </div>

            <!-- 2. PDI Section -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <div class="section-head mt-0">
                        <span>2. PDI Performance</span>
                        <select id="pdiAttempt" class="form-select w-auto" onchange="togglePDI()">
                            <option value="" disabled selected>PDI Offer? (Select)</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div id="pdiFields" class="hidden">
                        <div class="row g-3">
                            <div class="col-md-3"><label>PDI Offer Qty</label><input type="number" id="pdiOffer" class="form-control" oninput="calcPDI()"></div>
                            <div class="col-md-3"><label>PDI Pass Qty</label><input type="number" id="pdiPass" class="form-control" oninput="calcPDI()"></div>
                            <div class="col-md-3"><label>PDI Fail Qty</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                            <div class="col-md-3"><label>PDI Pass Rate %</label><input type="text" id="pdiRate" class="form-control" readonly></div>
                        </div>

                        <!-- PDI FAILURE DETAILS (Opened if Fail > 0) -->
                        <div id="pdiFailSection" class="hidden mt-4 border border-danger p-3 rounded bg-white">
                            <h5 class="text-danger border-bottom pb-2">‚ö†Ô∏è PDI Failure Analysis</h5>
                            
                            <table class="table table-bordered align-middle">
                                <thead class="table-danger">
                                    <tr><th width="15%">Category</th><th>Defect Details</th><th width="10%">Qty</th><th>Root Cause</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>1. Function</strong></td>
                                        <td><input type="text" id="pfd" class="form-control" placeholder="Details"></td>
                                        <td><input type="number" id="pfq" class="form-control" placeholder="0"></td>
                                        <td><input type="text" id="pfc" class="form-control" placeholder="Cause"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>2. Aesthetic</strong></td>
                                        <td><input type="text" id="pad" class="form-control" placeholder="Details"></td>
                                        <td><input type="number" id="paq" class="form-control" placeholder="0"></td>
                                        <td><input type="text" id="pac" class="form-control" placeholder="Cause"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>3. Packing</strong></td>
                                        <td><input type="text" id="ppd" class="form-control" placeholder="Details"></td>
                                        <td><input type="number" id="ppq" class="form-control" placeholder="0"></td>
                                        <td><input type="text" id="ppc" class="form-control" placeholder="Cause"></td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Traceability & CAPA -->
                            <div class="row g-3 mt-3">
                                <div class="col-12 fw-bold text-primary border-bottom">Traceability & CAPA</div>
                                <div class="col-md-3"><small>Master Carton Date</small><input type="datetime-local" id="mcDate" class="form-control"></div>
                                <div class="col-md-3"><small>LQC Date</small><input type="datetime-local" id="lqcDate" class="form-control"></div>
                                <div class="col-md-3"><small>LQC Operator</small><input type="text" id="lqcName" class="form-control"></div>
                                <div class="col-md-3"><small>Test Operator</small><input type="text" id="testName" class="form-control"></div>
                                
                                <div class="col-md-12"><label>Problem Description</label><input type="text" id="probDesc" class="form-control"></div>
                                <div class="col-md-4"><label>Root Cause</label><textarea id="rootCause" class="form-control"></textarea></div>
                                <div class="col-md-4"><label>Corrective Action</label><textarea id="corrAction" class="form-control"></textarea></div>
                                <div class="col-md-4"><label>Preventive Action</label><textarea id="prevAction" class="form-control"></textarea></div>
                                
                                <div class="col-12">
                                    <label>Upload Evidence (Images)</label>
                                    <input type="file" id="evidFiles" class="form-control" multiple onchange="previewImgs()">
                                    <div id="previewBox" class="d-flex mt-2 gap-2 flex-wrap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center gap-3 mt-4">
                <button type="button" class="btn btn-dark" onclick="showPreview()">üëÅÔ∏è Preview & Submit</button>
            </div>
        </form>
    </div>

    <!-- === DASHBOARD TAB === -->
    <div class="tab-pane fade" id="dashTab">
        <div class="card p-3 mb-3 no-print">
            <div class="row align-items-end">
                <div class="col-md-4"><label>Start Date</label><input type="date" id="startDate" class="form-control"></div>
                <div class="col-md-4"><label>End Date</label><input type="date" id="endDate" class="form-control"></div>
                <div class="col-md-4"><button class="btn btn-primary w-100" onclick="loadDashboard()">Search Data</button></div>
            </div>
        </div>

        <div id="dashContent" class="hidden">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="chart-box text-center border-success border-start border-5">
                        <small>Avg FPY</small>
                        <h2 class="text-success fw-bold" id="d-fpy">0%</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="chart-box text-center border-danger border-start border-5">
                        <small>Avg Process Defect</small>
                        <h2 class="text-danger fw-bold" id="d-proc">0%</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="chart-box text-center border-warning border-start border-5">
                        <small>Top Issue</small>
                        <h4 class="mt-2" id="d-top">-</h4>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8"><div class="chart-box"><canvas id="trendChart"></canvas></div></div>
                <div class="col-md-4"><div class="chart-box"><canvas id="paretoChart"></canvas></div></div>
            </div>
        </div>
        <div id="loading" class="text-center mt-5 hidden">
            <div class="spinner-border text-primary"></div>
            <p>Fetching Data...</p>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="prevModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">Confirm Full Data</h5></div>
            <div class="modal-body" id="prevContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button type="button" class="btn btn-success" id="finalSaveBtn" onclick="saveToCloud()">‚úÖ Final Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const LOGO_URL = "https://via.placeholder.com/150x50?text=CALIFONIX"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzFxLGszPBBh0xjJt26djjmF50WzRC_moBbujsKyubsd-mZV6kcHKyoUfPYxPaA6JQ/exec"; 

    document.getElementById('navLogo').src = LOGO_URL;
    document.getElementById('date').valueAsDate = new Date();

    // --- 1. CALCULATIONS (RMD vs Process) ---
    function calcRates() {
        const inp = +document.getElementById('inputQty').value || 0;
        let rmdQty = 0, procQty = 0;
        
        document.querySelectorAll('#prodTable tbody tr').forEach(row => {
            const q = +row.querySelector('.d-qty').value || 0;
            const t = row.querySelector('.d-type').value;
            if (t === 'RMD') rmdQty += q;
            else procQty += q;
        });

        const totalDef = rmdQty + procQty;
        document.getElementById('defectQty').value = totalDef;
        document.getElementById('rmdRate').value = inp ? ((rmdQty/inp)*100).toFixed(2)+"%" : "0%";
        document.getElementById('procRate').value = inp ? ((procQty/inp)*100).toFixed(2)+"%" : "0%";
        document.getElementById('totalRate').value = inp ? ((totalDef/inp)*100).toFixed(2)+"%" : "0%";
    }

    function addProdRow() {
        const t = document.querySelector('#prodTable tbody');
        t.insertAdjacentHTML('beforeend', `<tr>
            <td><input type="text" class="form-control d-name" placeholder="Details"></td>
            <td><input type="number" class="form-control d-qty" oninput="calcRates()"></td>
            <td><select class="form-select d-type" onchange="calcRates()"><option>Process</option><option>RMD</option></select></td>
            <td><input type="text" class="form-control d-cause"></td>
            <td><input type="text" class="form-control d-action"></td>
            <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcRates()">X</button></td>
        </tr>`);
    }

    // --- 2. PDI LOGIC ---
    function togglePDI() {
        const val = document.getElementById('pdiAttempt').value;
        const div = document.getElementById('pdiFields');
        if(val === 'Yes') div.classList.remove('hidden');
        else div.classList.add('hidden');
    }

    function calcPDI() {
        const offer = +document.getElementById('pdiOffer').value || 0;
        const pass = +document.getElementById('pdiPass').value || 0;
        const fail = offer - pass;

        document.getElementById('pdiFail').value = fail;
        document.getElementById('pdiRate').value = offer ? ((pass/offer)*100).toFixed(2)+"%" : "0%";

        const sec = document.getElementById('pdiFailSection');
        if(fail > 0) sec.classList.remove('hidden');
        else sec.classList.add('hidden');
    }

    // --- 3. PREVIEW FULL DATA ---
    function showPreview() {
        // Gather Data
        let html = `<div class="table-responsive"><table class="table table-bordered table-sm">`;
        html += `<tr class="table-light"><th colspan="4">General Info</th></tr>`;
        html += `<tr><th>Date</th><td>${document.getElementById('date').value}</td><th>Model</th><td>${document.getElementById('model').value}</td></tr>`;
        html += `<tr><th>Input</th><td>${document.getElementById('inputQty').value}</td><th>FG</th><td>${document.getElementById('fgQty').value}</td></tr>`;
        html += `<tr><th>RMD %</th><td>${document.getElementById('rmdRate').value}</td><th>Process %</th><td>${document.getElementById('procRate').value}</td></tr>`;
        
        // PDI
        if(document.getElementById('pdiAttempt').value === 'Yes') {
            html += `<tr class="table-light"><th colspan="4">PDI Info (Failed: ${document.getElementById('pdiFail').value})</th></tr>`;
            if(+document.getElementById('pdiFail').value > 0) {
                html += `<tr><td colspan="4">
                    <strong>Function:</strong> ${document.getElementById('pfd').value} (Qty: ${document.getElementById('pfq').value})<br>
                    <strong>Aesthetic:</strong> ${document.getElementById('pad').value} (Qty: ${document.getElementById('paq').value})<br>
                    <strong>Packing:</strong> ${document.getElementById('ppd').value} (Qty: ${document.getElementById('ppq').value})
                </td></tr>`;
                html += `<tr><th>Prob Desc</th><td colspan="3">${document.getElementById('probDesc').value}</td></tr>`;
                html += `<tr><th>LQC Name</th><td>${document.getElementById('lqcName').value}</td><th>Test Name</th><td>${document.getElementById('testName').value}</td></tr>`;
            }
        }
        html += `</table></div>`;
        
        document.getElementById('prevContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('prevModal')).show();
    }

    // --- 4. SAVE TO CLOUD ---
    let imgStore = [];
    function previewImgs() {
        const files = document.getElementById('evidFiles').files;
        const box = document.getElementById('previewBox');
        box.innerHTML = ""; imgStore = [];
        Array.from(files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { imgStore.push(e.target.result); box.innerHTML += `<img src="${e.target.result}" style="height:50px">`; };
            r.readAsDataURL(f);
        });
    }

    function saveToCloud() {
        const btn = document.getElementById('finalSaveBtn');
        btn.innerText = "Sending..."; btn.disabled = true;

        let prodDef = [];
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            prodDef.push({
                name: r.querySelector('.d-name').value,
                qty: r.querySelector('.d-qty').value,
                type: r.querySelector('.d-type').value
            });
        });

        const payload = {
            date: document.getElementById('date').value,
            model: document.getElementById('model').value,
            colour: document.getElementById('colour').value,
            inputQty: document.getElementById('inputQty').value,
            fgQty: document.getElementById('fgQty').value,
            defectQty: document.getElementById('defectQty').value,
            defectRate: document.getElementById('totalRate').value,
            rmdRate: document.getElementById('rmdRate').value,
            procRate: document.getElementById('procRate').value,
            prodDefects: prodDef,
            pdiAttempt: document.getElementById('pdiAttempt').value,
            pdiOffer: document.getElementById('pdiOffer').value,
            pdiPass: document.getElementById('pdiPass').value,
            pdiFail: document.getElementById('pdiFail').value,
            pdiRate: document.getElementById('pdiRate').value,
            pdiDetails: {
                func: { d: document.getElementById('pfd').value, qty: document.getElementById('pfq').value, cause: document.getElementById('pfc').value },
                aes: { d: document.getElementById('pad').value, qty: document.getElementById('paq').value, cause: document.getElementById('pac').value },
                pack: { d: document.getElementById('ppd').value, qty: document.getElementById('ppq').value, cause: document.getElementById('ppc').value }
            },
            trace: { mc: document.getElementById('mcDate').value, lqc: document.getElementById('lqcDate').value, lqcN: document.getElementById('lqcName').value, testN: document.getElementById('testName').value },
            capa: { prob: document.getElementById('probDesc').value, rca: document.getElementById('rootCause').value, ca: document.getElementById('corrAction').value, pa: document.getElementById('prevAction').value },
            images: imgStore
        };

        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Data Saved Successfully!");
            localStorage.removeItem("qaDraft"); // Clear draft
            location.reload();
        }).catch(e => { alert("Error: "+e); btn.disabled=false; });
    }

    // --- 5. PARTIAL SAVE (DRAFT) ---
    function saveDraft() {
        const data = {
            model: document.getElementById('model').value,
            fg: document.getElementById('fgQty').value,
            input: document.getElementById('inputQty').value
            // Add other critical fields here
        };
        localStorage.setItem("qaDraft", JSON.stringify(data));
        const msg = document.getElementById('draftMsg');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 2000);
    }

    window.onload = () => {
        const draft = localStorage.getItem("qaDraft");
        if(draft) {
            const d = JSON.parse(draft);
            if(d.model) document.getElementById('model').value = d.model;
            if(d.fg) document.getElementById('fgQty').value = d.fg;
            if(d.input) document.getElementById('inputQty').value = d.input;
        }
    }

    // --- 6. DASHBOARD FIX ---
    let c1, c2;
    function loadDashboard() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('dashContent').classList.add('hidden');

        fetch(SCRIPT_URL)
        .then(r => r.json())
        .then(data => {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashContent').classList.remove('hidden');

            const sDate = document.getElementById('startDate').value;
            const eDate = document.getElementById('endDate').value;
            
            // Filter Data
            const filtered = data.filter(row => {
                let d = row[1].split('T')[0];
                return (!sDate || d >= sDate) && (!eDate || d <= eDate);
            });

            if(filtered.length === 0) { alert("No data found for this date range"); return; }

            // Process Data
            let dates = [], fpy = [], defects = {};
            let totalProc = 0, count = 0;

            filtered.forEach(r => {
                dates.push(new Date(r[1]).toLocaleDateString());
                let inp = r[4], fg = r[5];
                fpy.push(inp ? (fg/inp)*100 : 0);
                totalProc += parseFloat(r[9] || 0); // Process Rate
                count++;

                // Parse Prod Defects
                try {
                    JSON.parse(r[10]).forEach(d => defects[d.name] = (defects[d.name] || 0) + (+d.qty));
                } catch(e){}
            });

            // Update UI
            let avgFPY = fpy.reduce((a,b)=>a+b,0)/count;
            let avgProc = totalProc/count;
            document.getElementById('d-fpy').innerText = avgFPY.toFixed(1)+"%";
            document.getElementById('d-proc').innerText = avgProc.toFixed(1)+"%";

            let topD = Object.entries(defects).sort((a,b)=>b[1]-a[1]);
            document.getElementById('d-top').innerText = topD.length ? topD[0][0] : "-";

            // Charts
            if(c1) c1.destroy();
            c1 = new Chart(document.getElementById('trendChart'), {
                type: 'line', data: { labels: dates, datasets: [{ label:'FPY Trend', data: fpy, borderColor: 'green' }] }
            });

            if(c2) c2.destroy();
            c2 = new Chart(document.getElementById('paretoChart'), {
                type: 'bar', data: { labels: topD.slice(0,5).map(x=>x[0]), datasets: [{ label:'Qty', data: topD.slice(0,5).map(x=>x[1]), backgroundColor: 'red' }] }
            });

        }).catch(e => {
            alert("Dashboard Error. Check Console.");
            console.error(e);
            document.getElementById('loading').classList.add('hidden');
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

