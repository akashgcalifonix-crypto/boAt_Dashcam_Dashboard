<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Dash Cam Report</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .header { background: #fff; border-bottom: 4px solid #0d6efd; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { max-height: 60px; } 
        .section-title { background: #e9ecef; padding: 8px; font-weight: bold; border-left: 5px solid #0d6efd; margin-bottom: 15px; }
        .hidden { display: none; }
        .preview-img { width: 50px; height: 50px; object-fit: cover; border: 1px solid #ddd; margin: 2px; }
    </style>
</head>
<body>

<!-- 1. HEADER & LOGO -->
<div class="header shadow-sm">
    <div>
        <!-- LOGO CHANGE: Niche src=".." ke andar apna URL dalein -->
        <img src="https://via.placeholder.com/200x60?text=CALIFONIX+LOGO" alt="Califonix" class="logo-img" id="logoImage">
    </div>
    <h3 class="text-primary m-0">Daily Quality Dashboard</h3>
    <div class="fw-bold text-muted" id="currentDate"></div>
</div>

<div class="container mt-4 pb-5">
    <form id="dashForm">
        
        <!-- SECTION 1: PRODUCTION INFO -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="section-title">1. Production Details</div>
                <div class="row g-3">
                    <div class="col-md-3"><label>Date</label><input type="date" id="date" class="form-control"></div>
                    <div class="col-md-3"><label>Model</label><input type="text" id="model" class="form-control"></div>
                    <div class="col-md-3"><label>Colour</label><input type="text" id="colour" class="form-control"></div>
                    <div class="col-md-3"><label>Input Qty</label><input type="number" id="inputQty" class="form-control" oninput="calcAll()"></div>
                    
                    <div class="col-md-3"><label>Total Defect Qty</label><input type="number" id="defectQty" class="form-control" oninput="calcAll()"></div>
                    <div class="col-md-3"><label>FG (Passed)</label><input type="number" id="fgQty" class="form-control" readonly style="background:#e8f5e9"></div>
                    <div class="col-md-3"><label>Defect Rate %</label><input type="text" id="defectRate" class="form-control fw-bold text-danger" readonly></div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: DEFECT DETAILS (FIXED 3 TYPES) -->
        <div class="card shadow-sm mb-4 border-warning">
            <div class="card-body">
                <div class="section-title bg-warning text-dark">2. Defect Bifurcation</div>
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th width="20%">Defect Category</th>
                            <th width="15%">Defect Qty</th>
                            <th>Cause / Root Cause Analysis (Process & RMD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 1. Function -->
                        <tr>
                            <td class="fw-bold">1. Function</td>
                            <td><input type="number" id="funcQty" class="form-control" placeholder="0"></td>
                            <td><input type="text" id="funcCause" class="form-control" placeholder="Enter Cause"></td>
                        </tr>
                        <!-- 2. Aesthetic -->
                        <tr>
                            <td class="fw-bold">2. Aesthetic</td>
                            <td><input type="number" id="aesQty" class="form-control" placeholder="0"></td>
                            <td><input type="text" id="aesCause" class="form-control" placeholder="Enter Cause"></td>
                        </tr>
                        <!-- 3. Packing -->
                        <tr>
                            <td class="fw-bold">3. Packing</td>
                            <td><input type="number" id="packQty" class="form-control" placeholder="0"></td>
                            <td><input type="text" id="packCause" class="form-control" placeholder="Enter Cause"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION 3: PDI & EVIDENCE -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="section-title">3. PDI & Evidence</div>
                <div class="row g-3">
                    <div class="col-md-3"><label>PDI Offer Qty</label><input type="number" id="pdiOffer" class="form-control" oninput="calcAll()"></div>
                    <div class="col-md-3"><label>PDI Pass Qty</label><input type="number" id="pdiPass" class="form-control" oninput="calcAll()"></div>
                    <div class="col-md-3"><label>PDI Fail Qty</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                    <div class="col-md-3"><label>Pass Rate %</label><input type="text" id="pdiRate" class="form-control" readonly></div>
                </div>

                <!-- Rejection Details (Conditional) -->
                <div id="rejSection" class="mt-3 p-3 border border-danger rounded bg-light hidden">
                    <h6 class="text-danger fw-bold">‚ö†Ô∏è PDI Rejection Details</h6>
                    <textarea id="rejDetails" class="form-control" placeholder="Describe the PDI Failure problem here..."></textarea>
                </div>

                <!-- Image Upload -->
                <div class="mt-4">
                    <label class="fw-bold">Upload Evidence Images (Multiple)</label>
                    <input type="file" id="evidenceFiles" class="form-control" multiple accept="image/*" onchange="previewImages()">
                    <div id="imgPreviewBox" class="d-flex mt-2 flex-wrap"></div>
                    <small class="text-muted">Note: These images will be added to the PPT.</small>
                </div>
            </div>
        </div>

        <!-- BUTTONS -->
        <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-info text-white" onclick="showPreview()">üëÅÔ∏è Preview Data</button>
            <button type="button" class="btn btn-primary" onclick="downloadPPT()">üìò Download PPT</button>
        </div>
    </form>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Final Review</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button type="button" class="btn btn-success" id="finalSaveBtn" onclick="saveToGoogle()">‚úÖ Confirm & Save to Sheet</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    // STEP 1 WALA URL YAHAN PASTE KAREIN
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxbZDIfttehr7ElXWqF7-vCaKT1TFS862F7D3wAcv52quGMVLDSY9X2kKSfDC8ml2WTDw/exec"; 
    
    // Init Date
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('currentDate').innerText = new Date().toDateString();

    // --- CALCULATIONS ---
    function calcAll() {
        let inp = +document.getElementById('inputQty').value || 0;
        let def = +document.getElementById('defectQty').value || 0;
        let fg = inp - def;
        
        document.getElementById('fgQty').value = fg;
        document.getElementById('defectRate').value = inp ? ((def/inp)*100).toFixed(2) + "%" : "0%";

        let pOffer = +document.getElementById('pdiOffer').value || 0;
        let pPass = +document.getElementById('pdiPass').value || 0;
        let pFail = pOffer - pPass;

        document.getElementById('pdiFail').value = pFail;
        document.getElementById('pdiRate').value = pOffer ? ((pPass/pOffer)*100).toFixed(2) + "%" : "0%";

        if(pFail > 0) document.getElementById('rejSection').classList.remove('hidden');
        else document.getElementById('rejSection').classList.add('hidden');
    }

    // --- IMAGE PREVIEW ---
    let base64Images = []; // Store for Script/PPT

    function previewImages() {
        const files = document.getElementById('evidenceFiles').files;
        const box = document.getElementById('imgPreviewBox');
        box.innerHTML = "";
        base64Images = [];

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Show on UI
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-img';
                box.appendChild(img);
                
                // Store for sending
                base64Images.push(e.target.result); 
            };
            reader.readAsDataURL(file);
        });
    }

    // --- PREVIEW MODAL ---
    function showPreview() {
        let html = `<table class="table table-sm table-bordered">`;
        html += `<tr><th>Date</th><td>${document.getElementById('date').value}</td></tr>`;
        html += `<tr><th>Model</th><td>${document.getElementById('model').value}</td></tr>`;
        html += `<tr><th>FG Qty</th><td>${document.getElementById('fgQty').value}</td></tr>`;
        html += `<tr><th>Defect Rate</th><td>${document.getElementById('defectRate').value}</td></tr>`;
        
        html += `<tr><th colspan="2" class="bg-light">Defects</th></tr>`;
        html += `<tr><td>Function</td><td>Qty: ${document.getElementById('funcQty').value} | Cause: ${document.getElementById('funcCause').value}</td></tr>`;
        html += `<tr><td>Aesthetic</td><td>Qty: ${document.getElementById('aesQty').value} | Cause: ${document.getElementById('aesCause').value}</td></tr>`;
        html += `<tr><td>Packing</td><td>Qty: ${document.getElementById('packQty').value} | Cause: ${document.getElementById('packCause').value}</td></tr>`;
        
        html += `</table>`;
        
        document.getElementById('previewContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    // --- SAVE TO GOOGLE SHEET ---
    function saveToGoogle() {
        const btn = document.getElementById('finalSaveBtn');
        btn.innerText = "Saving (Wait)...";
        btn.disabled = true;

        const payload = {
            date: document.getElementById('date').value,
            model: document.getElementById('model').value,
            colour: document.getElementById('colour').value,
            inputQty: document.getElementById('inputQty').value,
            fgQty: document.getElementById('fgQty').value,
            defectQty: document.getElementById('defectQty').value,
            defectRate: document.getElementById('defectRate').value,
            defects: {
                func: { qty: document.getElementById('funcQty').value, cause: document.getElementById('funcCause').value },
                aes: { qty: document.getElementById('aesQty').value, cause: document.getElementById('aesCause').value },
                pack: { qty: document.getElementById('packQty').value, cause: document.getElementById('packCause').value }
            },
            pdiPass: document.getElementById('pdiPass').value,
            pdiFail: document.getElementById('pdiFail').value,
            pdiRate: document.getElementById('pdiRate').value,
            rejDetails: document.getElementById('rejDetails').value,
            images: base64Images // Sending images to script
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            alert("‚úÖ Data Saved Successfully!");
            location.reload(); // Refresh page
        }).catch(err => {
            console.error(err);
            alert("‚ö†Ô∏è Error: Check Console.");
            btn.disabled = false;
        });
    }

    // --- PPT GENERATION ---
    function downloadPPT() {
        let pres = new PptxGenJS();
        
        // SLIDE 1: Title
        let slide1 = pres.addSlide();
        slide1.background = { color: 'F1F1F1' };
        slide1.addText("CALIFONIX", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: '0d6efd' });
        slide1.addText("Daily Quality Report", { x: 0.5, y: 1.5, fontSize: 32, bold: true, align: 'center' });
        slide1.addText(`Date: ${document.getElementById('date').value}`, { x: 0.5, y: 2.5, fontSize: 18, align: 'center' });

        // SLIDE 2: Defect Table
        let slide2 = pres.addSlide();
        slide2.addText("Defect Bifurcation", { x: 0.5, y: 0.5, fontSize: 18, bold: true, color: '0d6efd' });
        
        let rows = [
            [{ text: "Category", options: { fill: '0d6efd', color: 'ffffff', bold: true } }, { text: "Qty", options: { fill: '0d6efd', color: 'ffffff', bold: true } }, { text: "Cause", options: { fill: '0d6efd', color: 'ffffff', bold: true } }],
            ["Function", document.getElementById('funcQty').value || "0", document.getElementById('funcCause').value || "-"],
            ["Aesthetic", document.getElementById('aesQty').value || "0", document.getElementById('aesCause').value || "-"],
            ["Packing", document.getElementById('packQty').value || "0", document.getElementById('packCause').value || "-"]
        ];
        slide2.addTable(rows, { x: 0.5, y: 1.0, w: 9, border: { pt: 1, color: "dddddd" } });

        // SLIDE 3: Evidence Images
        if(base64Images.length > 0) {
            let slide3 = pres.addSlide();
            slide3.addText("Evidence / Failure Images", { x: 0.5, y: 0.5, fontSize: 18, bold: true, color: 'DC3545' });
            
            let xPos = 0.5;
            base64Images.forEach((imgData, index) => {
                if(index < 3) { // Limit to 3 images per slide to fit
                    slide3.addImage({ data: imgData, x: xPos, y: 1.5, w: 2.5, h: 2.5 });
                    xPos += 2.7;
                }
            });
        }

        pres.writeFile({ fileName: `Califonix_Report_${document.getElementById('date').value}.pptx` });
    }
</script>

</body>
</html>
