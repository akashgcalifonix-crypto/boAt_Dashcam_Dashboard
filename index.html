<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Suite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .nav-tabs .nav-link.active { background-color: #0d6efd; color: white; border: none; }
        .section-header { background: #e9ecef; padding: 10px; border-left: 5px solid #0d6efd; font-weight: bold; margin-top: 20px; }
        .hidden { display: none; }
        .chart-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .logo { height: 50px; }
    </style>
</head>
<body>

<!-- NAVBAR -->
<div class="bg-white shadow-sm p-3 mb-4 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <!-- LOGO HERE -->
        <img src="https://via.placeholder.com/150x50?text=CALIFONIX" class="logo" id="mainLogo">
        <h4 class="ms-3 mb-0 text-primary">Quality Assurance System</h4>
    </div>
    <ul class="nav nav-tabs border-0">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#entryTab">üìù Data Entry</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dashTab" onclick="loadDashboard()">üìä Analytics Dashboard</a></li>
    </ul>
</div>

<div class="container pb-5 tab-content">

    <!-- TAB 1: DATA ENTRY -->
    <div class="tab-pane fade show active" id="entryTab">
        <form id="qaForm">
            <!-- 1. Production Info -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="section-header mt-0">1. Production Details</div>
                    <div class="row g-3">
                        <div class="col-md-3"><label>Date</label><input type="date" id="date" class="form-control"></div>
                        <div class="col-md-3"><label>Model</label><input type="text" id="model" class="form-control"></div>
                        <div class="col-md-3"><label>Colour</label><input type="text" id="colour" class="form-control"></div>
                        <div class="col-md-3"><label>Input Qty</label><input type="number" id="inputQty" class="form-control"></div>
                        
                        <div class="col-md-3"><label>Defect Qty</label><input type="number" id="defectQty" class="form-control" oninput="calcRates()"></div>
                        <div class="col-md-3"><label>FG Qty (Manual)</label><input type="number" id="fgQty" class="form-control"></div>
                        <div class="col-md-3"><label>Defect Rate %</label><input type="text" id="defectRate" class="form-control fw-bold text-danger" readonly></div>
                    </div>

                    <!-- Production Defect Bifurcation -->
                    <div class="section-header">2. Production Defect Analysis</div>
                    <table class="table table-bordered" id="prodDefectTable">
                        <thead class="table-light">
                            <tr><th>Defect Name</th><th>Qty</th><th>Type</th><th>Cause</th><th>Action</th><th></th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProdRow()">+ Add Defect</button>
                </div>
            </div>

            <!-- 2. PDI Info -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <div class="section-header mt-0">3. PDI Performance</div>
                    <div class="row g-3">
                        <div class="col-md-3"><label>PDI Offer Qty</label><input type="number" id="pdiOffer" class="form-control" oninput="calcPDI()"></div>
                        <div class="col-md-3"><label>PDI Pass Qty</label><input type="number" id="pdiPass" class="form-control" oninput="calcPDI()"></div>
                        <div class="col-md-3"><label>PDI Fail Qty</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                        <div class="col-md-3"><label>PDI Pass Rate</label><input type="text" id="pdiRate" class="form-control" readonly></div>
                    </div>

                    <!-- PDI FAIL SECTION (Hidden) -->
                    <div id="pdiFailSection" class="hidden mt-4 border border-danger p-3 rounded bg-light">
                        <h5 class="text-danger border-bottom pb-2">‚ö†Ô∏è PDI Failure Report (CAPA)</h5>
                        
                        <!-- PDI Bifurcation -->
                        <table class="table table-sm table-bordered bg-white">
                            <thead><tr><th>Category</th><th>Qty</th><th>Root Cause Analysis</th></tr></thead>
                            <tbody>
                                <tr><td>Function</td><td><input type="number" id="pFuncQ" class="form-control"></td><td><input type="text" id="pFuncC" class="form-control"></td></tr>
                                <tr><td>Aesthetic</td><td><input type="number" id="pAesQ" class="form-control"></td><td><input type="text" id="pAesC" class="form-control"></td></tr>
                                <tr><td>Packing</td><td><input type="number" id="pPackQ" class="form-control"></td><td><input type="text" id="pPackC" class="form-control"></td></tr>
                            </tbody>
                        </table>

                        <!-- Traceability -->
                        <div class="row g-2 mt-3">
                            <div class="col-md-3"><label>Master Carton Date</label><input type="datetime-local" id="mcDate" class="form-control"></div>
                            <div class="col-md-3"><label>LQC Date</label><input type="datetime-local" id="lqcDate" class="form-control"></div>
                            <div class="col-md-3"><label>LQC Operator</label><input type="text" id="lqcName" class="form-control"></div>
                            <div class="col-md-3"><label>Testing Date</label><input type="datetime-local" id="testDate" class="form-control"></div>
                            <div class="col-md-3"><label>Testing Operator</label><input type="text" id="testName" class="form-control"></div>
                        </div>

                        <!-- CAPA -->
                        <div class="row g-3 mt-2">
                            <div class="col-12"><label>Problem Description</label><input type="text" id="probDesc" class="form-control"></div>
                            <div class="col-md-4"><label>Root Cause</label><textarea id="rootCause" class="form-control"></textarea></div>
                            <div class="col-md-4"><label>Corrective Action</label><textarea id="corrAction" class="form-control"></textarea></div>
                            <div class="col-md-4"><label>Preventive Action</label><textarea id="prevAction" class="form-control"></textarea></div>
                            <div class="col-12">
                                <label>Upload Evidence (Images)</label>
                                <input type="file" id="evidFiles" class="form-control" multiple onchange="previewImgs()">
                                <div id="previewBox" class="d-flex mt-2 gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-3 justify-content-center mt-4">
                <button type="button" class="btn btn-dark" onclick="showPreview()">üëÅÔ∏è Preview Data</button>
                <button type="button" class="btn btn-success" onclick="downloadExcel()">üìó Excel</button>
                <button type="button" class="btn btn-primary" onclick="downloadPPT()">üìò PPT</button>
            </div>
        </form>
    </div>

    <!-- TAB 2: DASHBOARD -->
    <div class="tab-pane fade" id="dashTab">
        <div class="d-flex justify-content-between mb-3">
            <h4>Performance Analytics</h4>
            <button class="btn btn-primary btn-sm" onclick="loadDashboard()">üîÑ Refresh Data</button>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white text-center p-3">
                    <h3><span id="avgFPY">0</span>%</h3>
                    <small>Average FPY</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white text-center p-3">
                    <h3><span id="avgDefect">0</span>%</h3>
                    <small>Process Defect Rate</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark text-center p-3">
                    <h3 id="topDefectName">-</h3>
                    <small>Top Issue</small>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-8">
                <div class="chart-box">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-box">
                    <canvas id="paretoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="prevModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Confirm Submission</h5></div>
            <div class="modal-body" id="prevContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button class="btn btn-success" id="finalSave" onclick="saveData()">‚úÖ Submit to Database</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxhyHwmFBNc6YXiGI8CbG8ROdt-YsZzvxBWXZay85OpIsCr11eE7kItdEQ2znJcSHEzaA/exec"; // PASTE URL HERE

    // --- 1. DATA ENTRY LOGIC ---
    document.getElementById('date').valueAsDate = new Date();

    function calcRates() {
        let inp = +document.getElementById('inputQty').value || 0;
        let def = +document.getElementById('defectQty').value || 0;
        document.getElementById('defectRate').value = inp ? ((def/inp)*100).toFixed(2) + "%" : "0%";
    }

    function calcPDI() {
        let offer = +document.getElementById('pdiOffer').value || 0;
        let pass = +document.getElementById('pdiPass').value || 0;
        let fail = offer - pass;
        document.getElementById('pdiFail').value = fail;
        document.getElementById('pdiRate').value = offer ? ((pass/offer)*100).toFixed(2) + "%" : "0%";

        const sec = document.getElementById('pdiFailSection');
        if(fail > 0) sec.classList.remove('hidden');
        else sec.classList.add('hidden');
    }

    function addProdRow() {
        const tbody = document.querySelector('#prodDefectTable tbody');
        const row = `<tr>
            <td><input type="text" class="form-control d-name"></td>
            <td><input type="number" class="form-control d-qty"></td>
            <td><select class="form-select d-type"><option>Process</option><option>RMD</option></select></td>
            <td><input type="text" class="form-control d-cause" placeholder="Cause"></td>
            <td><input type="text" class="form-control d-action" placeholder="Action"></td>
            <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    let imgFiles = [];
    function previewImgs() {
        const files = document.getElementById('evidFiles').files;
        const box = document.getElementById('previewBox');
        box.innerHTML = "";
        imgFiles = [];
        Array.from(files).forEach(f => {
            const reader = new FileReader();
            reader.onload = e => {
                imgFiles.push(e.target.result);
                box.innerHTML += `<img src="${e.target.result}" style="height:60px; border:1px solid #ccc">`;
            }
            reader.readAsDataURL(f);
        });
    }

    // --- 2. PREVIEW & SAVE ---
    function showPreview() {
        // Collect Data
        let html = `<table class="table table-bordered">`;
        html += `<tr><th>Model</th><td>${document.getElementById('model').value}</td><th>Date</th><td>${document.getElementById('date').value}</td></tr>`;
        html += `<tr><th>FG (Manual)</th><td>${document.getElementById('fgQty').value}</td><th>Defect Rate</th><td>${document.getElementById('defectRate').value}</td></tr>`;
        html += `</table>`;
        document.getElementById('prevContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('prevModal')).show();
    }

    function saveData() {
        const btn = document.getElementById('finalSave');
        btn.innerText = "Saving..."; btn.disabled = true;

        // Collect Prod Defects
        let pDefects = [];
        document.querySelectorAll('#prodDefectTable tbody tr').forEach(r => {
            pDefects.push({
                name: r.querySelector('.d-name').value,
                qty: r.querySelector('.d-qty').value,
                type: r.querySelector('.d-type').value,
                cause: r.querySelector('.d-cause').value,
                action: r.querySelector('.d-action').value
            });
        });

        const payload = {
            date: document.getElementById('date').value,
            model: document.getElementById('model').value,
            colour: document.getElementById('colour').value,
            inputQty: document.getElementById('inputQty').value,
            defectQty: document.getElementById('defectQty').value,
            fgQty: document.getElementById('fgQty').value,
            defectRate: document.getElementById('defectRate').value,
            prodDefects: pDefects,
            pdiOffer: document.getElementById('pdiOffer').value,
            pdiPass: document.getElementById('pdiPass').value,
            pdiFail: document.getElementById('pdiFail').value,
            pdiRate: document.getElementById('pdiRate').value,
            pdiDetails: {
                func: { qty: document.getElementById('pFuncQ').value, cause: document.getElementById('pFuncC').value },
                aes: { qty: document.getElementById('pAesQ').value, cause: document.getElementById('pAesC').value },
                pack: { qty: document.getElementById('pPackQ').value, cause: document.getElementById('pPackC').value }
            },
            trace: {
                mcDate: document.getElementById('mcDate').value,
                lqcDate: document.getElementById('lqcDate').value,
                lqcName: document.getElementById('lqcName').value,
                testDate: document.getElementById('testDate').value,
                testName: document.getElementById('testName').value
            },
            capa: {
                prob: document.getElementById('probDesc').value,
                rca: document.getElementById('rootCause').value,
                ca: document.getElementById('corrAction').value,
                pa: document.getElementById('prevAction').value
            },
            images: imgFiles
        };

        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Saved Successfully!");
            location.reload();
        }).catch(e => alert("Error: " + e));
    }

    // --- 3. PPT EXPORT ---
    function downloadPPT() {
        let pres = new PptxGenJS();
        let slide = pres.addSlide();
        
        // Logo (Assuming URL is valid)
        // slide.addImage({ path: document.getElementById('mainLogo').src, x:0.5, y:0.5, w:1.5, h:0.5 });
        slide.addText("Daily Quality Report", { x:0.5, y:1.0, fontSize:24, bold:true, color:'007bff' });
        
        // Add more slide logic here based on form data...
        // (Due to length, keeping it basic, but you can add tables as shown in previous code)
        
        pres.writeFile({ fileName: "Califonix_Report.pptx" });
    }

    // --- 4. DASHBOARD LOGIC ---
    let chart1, chart2;
    function loadDashboard() {
        fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            // Process Data
            let labels = [], fpy = [], defRate = [];
            let defectCounts = {};

            data.forEach(row => {
                labels.push(new Date(row[1]).toLocaleDateString()); // Date
                let input = row[4];
                let fg = row[6];
                let fpyVal = input ? (fg/input)*100 : 0;
                fpy.push(fpyVal);
                
                // Parse Defects JSON
                try {
                    let defs = JSON.parse(row[8]);
                    defs.forEach(d => {
                        if(defectCounts[d.name]) defectCounts[d.name] += +d.qty;
                        else defectCounts[d.name] = +d.qty;
                    });
                } catch(e) {}
            });

            // Update KPI Cards
            let avgF = fpy.reduce((a,b)=>a+b,0) / fpy.length || 0;
            document.getElementById('avgFPY').innerText = avgF.toFixed(1);
            
            // Charts
            const ctx1 = document.getElementById('trendChart');
            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'FPY %', data: fpy, borderColor: 'green', tension: 0.1 }]
                }
            });

            // Pareto Data Prep
            let sortedDefects = Object.entries(defectCounts).sort((a,b) => b[1]-a[1]).slice(0,5);
            const ctx2 = document.getElementById('paretoChart');
            if(chart2) chart2.destroy();
            chart2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: sortedDefects.map(x=>x[0]),
                    datasets: [{ label: 'Top 5 Defects', data: sortedDefects.map(x=>x[1]), backgroundColor: 'red' }]
                }
            });
            
            if(sortedDefects.length > 0) document.getElementById('topDefectName').innerText = sortedDefects[0][0];

        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
