<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Smart Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
     
    <style>
        :root { --primary: #0d6efd; --bg: #f8f9fa; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }
        .navbar { background: white; border-bottom: 3px solid var(--primary); }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-head { background: #e9ecef; padding: 10px 15px; border-radius: 8px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .kpi-box { color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .bg-grad-1 { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-grad-2 { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-grad-3 { background: linear-gradient(45deg, #e74a3b, #be2617); }
        .ai-btn { cursor: pointer; background: #6f42c1; color: white; border: none; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; }
        .ai-btn:hover { background: #5a32a3; }
        .preview-box { border: 2px solid var(--primary); padding: 20px; background: white; border-radius: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg px-4 sticky-top shadow-sm">
    <div class="d-flex align-items-center">
        <img id="navLogo" src="" style="height: 45px;" class="me-3">
        <div>
            <h5 class="text-primary fw-bold mb-0">Califonix Production System</h5>
            <small class="text-muted">Smart Report & Analytics</small>
        </div>
    </div>
    <div class="ms-auto">
        <ul class="nav nav-pills" id="mainTab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#entryTab">üìù Data Entry</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashTab" onclick="loadData()">üìä Dashboard</button></li>
        </ul>
    </div>
</nav>

<div class="container-fluid mt-4 px-4 pb-5 tab-content">

    <!-- DATA ENTRY TAB -->
    <div class="tab-pane fade show active" id="entryTab">
        <form id="mainForm">
            <input type="hidden" id="recordId"> 
            
            <!-- PRODUCTION INFO -->
            <div class="card">
                <div class="card-body">
                    <div class="section-head">
                        <span><i class="fas fa-industry"></i> Production Details</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetForm()">üîÑ Reset</button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-2"><label>Date</label><input type="date" id="date" class="form-control"></div>
                        <div class="col-md-2"><label>Line No</label><select id="line" class="form-select"><option>Line 1</option><option>Line 2</option><option>Line 3</option></select></div>
                        <div class="col-md-2"><label>Model Name</label><input type="text" id="model" class="form-control" placeholder="Enter Model"></div>
                        <div class="col-md-2"><label>Input Qty</label><input type="number" id="inputQty" class="form-control" oninput="calcRates()" placeholder="0"></div>
                        <div class="col-md-2"><label>FG (Pass)</label><input type="number" id="fgQty" class="form-control fw-bold text-success" readonly></div>
                        <div class="col-md-2"><label>FPY %</label><input type="text" id="fpyRate" class="form-control fw-bold text-primary" readonly></div>
                    </div>

                    <!-- DEFECT TABLE -->
                    <div class="mt-4 p-3 bg-light rounded border">
                        <h6 class="fw-bold text-danger">‚ö†Ô∏è Defects & Rejection</h6>
                        <table class="table table-bordered bg-white align-middle" id="prodTable">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Defect Name</th>
                                    <th width="100">Qty</th>
                                    <th>Rate %</th> <!-- NEW COLUMN REQUESTED -->
                                    <th>Type</th>
                                    <th>Root Cause</th>
                                    <th>Action Plan (AI)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addProdRow()">+ Add Defect</button>
                    </div>
                </div>
            </div>

            <!-- PDI INFO -->
            <div class="card">
                <div class="card-body">
                    <div class="section-head">
                        <span><i class="fas fa-check-circle"></i> PDI Performance</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pdiToggle" onchange="togglePDI()">
                            <label class="form-check-label">Enable PDI</label>
                        </div>
                    </div>
                    <div id="pdiSection" class="hidden">
                        <div class="row g-3">
                            <div class="col-md-3"><label>PDI Offer</label><input type="number" id="pdiOffer" class="form-control" oninput="calcPDI()"></div>
                            <div class="col-md-3"><label>PDI Pass</label><input type="number" id="pdiPass" class="form-control" oninput="calcPDI()"></div>
                            <div class="col-md-3"><label>PDI Fail</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                        </div>
                        <div class="mt-3">
                            <label>PDI Failure Details</label>
                            <input type="text" id="pdiDetails" class="form-control" placeholder="Describe failure reason if any...">
                            <button type="button" class="ai-btn mt-1" onclick="aiRewrite('pdiDetails')">‚ú® AI Fix</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center py-3">
                <button type="button" class="btn btn-dark btn-lg px-5 shadow" onclick="showPreview()">üëÅÔ∏è Preview & Submit</button>
            </div>
        </form>
    </div>

    <!-- DASHBOARD TAB -->
    <div class="tab-pane fade" id="dashTab">
        <div class="card p-3">
            <div class="row align-items-end g-2">
                <div class="col-md-3"><label>Start Date</label><input type="date" id="dashStart" class="form-control"></div>
                <div class="col-md-3"><label>End Date</label><input type="date" id="dashEnd" class="form-control"></div>
                <div class="col-md-3"><button class="btn btn-primary w-100" onclick="updateDash()">üîé Filter</button></div>
                <div class="col-md-3"><button class="btn btn-success w-100" onclick="exportExcel()">üì• Download Report</button></div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4"><div class="kpi-box bg-grad-1"><h3>Total Input</h3><h1 id="k-input">0</h1></div></div>
            <div class="col-md-4"><div class="kpi-box bg-grad-2"><h3>Avg FPY</h3><h1 id="k-fpy">0%</h1></div></div>
            <div class="col-md-4"><div class="kpi-box bg-grad-3"><h3>Total Defects</h3><h1 id="k-defects">0</h1></div></div>
        </div>

        <div class="row">
            <div class="col-md-8"><div class="card p-3"><h5>üìà Production Trend</h5><canvas id="chartTrend" style="height:300px"></canvas></div></div>
            <div class="col-md-4"><div class="card p-3"><h5>üìä Top 5 Defects</h5><canvas id="chartPareto" style="height:300px"></canvas></div></div>
        </div>

        <div class="card p-3 mt-3">
            <h5>üìù Records History (Edit / Delete)</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="recTable">
                    <thead class="table-dark"><tr><th>Date</th><th>Model</th><th>Input</th><th>FG</th><th>FPY</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="prevModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="prevContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button class="btn btn-success" id="finalBtn" onclick="submitData()">‚úÖ Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbyRgFGaZm1rvmvYST4Y94nrbvitSEauZ8KWs9_CpjeVVvuohhX8W7Kh_RGAQW8EMuJHiA/exec"; // üî¥ INSERT NEW SCRIPT URL HERE
    const GEMINI_API_KEY = "AIzaSyDwFbj25ROQX52IzObhVIW_6t61O5TC2pA"; 

    document.getElementById('navLogo').src = LOGO_URL;
    document.getElementById('date').valueAsDate = new Date();
    let ALL_DATA = [];

    // --- 1. AI FUNCTION (FIXED) ---
    async function aiRewrite(id) {
        if(!GEMINI_API_KEY) { alert("API Key Missing"); return; }
        const el = document.getElementById(id);
        if(!el.value) { alert("Write something first"); return; }
        
        const oldTxt = el.value;
        el.value = "AI rewriting..."; el.disabled = true;

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "Rewrite professionally: " + oldTxt }] }] })
            });
            const d = await res.json();
            el.value = d.candidates[0].content.parts[0].text;
        } catch(e) { 
            console.error(e); 
            el.value = oldTxt; 
            alert("AI Error. Check Console."); 
        }
        el.disabled = false;
    }

    // --- 2. CALCULATIONS ---
    function calcRates() {
        const inp = +document.getElementById('inputQty').value || 0;
        let totalDef = 0;

        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            const q = +r.querySelector('.d-qty').value || 0;
            totalDef += q;
            // Update Row Rate
            const rateField = r.querySelector('.d-rate');
            if(rateField) rateField.innerText = inp ? ((q/inp)*100).toFixed(2)+"%" : "0%";
        });

        const fg = inp - totalDef;
        document.getElementById('fgQty').value = fg > 0 ? fg : 0;
        document.getElementById('fpyRate').value = inp ? ((fg/inp)*100).toFixed(1)+"%" : "0%";
    }

    function addProdRow() {
        const id = 'act_' + Math.random().toString(36).substr(2, 5);
        document.querySelector('#prodTable tbody').insertAdjacentHTML('beforeend', `
            <tr>
                <td><input type="text" class="form-control d-name"></td>
                <td><input type="number" class="form-control d-qty" value="1" oninput="calcRates()"></td>
                <td class="text-danger fw-bold d-rate">0%</td>
                <td><select class="form-select d-type"><option>Process</option><option>RMD</option></select></td>
                <td><input type="text" class="form-control d-cause"></td>
                <td><div class="input-group"><input type="text" class="form-control d-action" id="${id}"><button class="ai-btn" onclick="aiRewrite('${id}')">AI</button></div></td>
                <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcRates()">X</button></td>
            </tr>
        `);
        calcRates();
    }

    // --- 3. SUBMIT / DELETE / EDIT ---
    function submitData() {
        const btn = document.getElementById('finalBtn');
        btn.innerText = "Sending..."; btn.disabled = true;

        let defects = [];
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            defects.push({
                name: r.querySelector('.d-name').value,
                qty: r.querySelector('.d-qty').value,
                type: r.querySelector('.d-type').value,
                cause: r.querySelector('.d-cause').value,
                action: r.querySelector('.d-action').value
            });
        });

        // Unique ID for New or Existing
        const recId = document.getElementById('recordId').value || Date.now().toString();
        const mode = document.getElementById('recordId').value ? 'edit' : 'submit';

        const payload = {
            action: mode,
            id: recId,
            date: document.getElementById('date').value,
            line: document.getElementById('line').value,
            model: document.getElementById('model').value,
            input: document.getElementById('inputQty').value,
            fg: document.getElementById('fgQty').value,
            fpy: document.getElementById('fpyRate').value,
            defects: JSON.stringify(defects),
            pdiDetails: {
                offer: document.getElementById('pdiOffer').value,
                pass: document.getElementById('pdiPass').value,
                fail: document.getElementById('pdiFail').value,
                note: document.getElementById('pdiDetails').value
            }
        };

        fetch(API_URL, {
            method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Success!"); location.reload();
        }).catch(e => { alert("Error: "+e); btn.disabled=false; });
    }

    function deleteRecord(id) {
        if(!confirm("Delete this record?")) return;
        fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ action: 'delete', id: id })
        }).then(() => { alert("Deleted! Refreshing..."); loadData(); });
    }

    // --- 4. DASHBOARD & PREVIEW ---
    function showPreview() {
        const d = {
            date: document.getElementById('date').value,
            model: document.getElementById('model').value,
            input: document.getElementById('inputQty').value,
            fg: document.getElementById('fgQty').value,
            fpy: document.getElementById('fpyRate').value
        };
        let rows = "";
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            rows += `<tr><td>${r.querySelector('.d-name').value}</td><td>${r.querySelector('.d-qty').value}</td><td>${r.querySelector('.d-cause').value}</td><td>${r.querySelector('.d-action').value}</td></tr>`;
        });

        document.getElementById('prevContent').innerHTML = `
            <div class="preview-box">
                <div class="d-flex justify-content-between border-bottom pb-2 mb-3">
                    <img src="${LOGO_URL}" height="50">
                    <div class="text-end"><h4>Production Report</h4><small>${d.date}</small></div>
                </div>
                <div class="row text-center mb-3">
                    <div class="col border-end"><h6>Input</h6><h4>${d.input}</h4></div>
                    <div class="col border-end"><h6>FG</h6><h4 class="text-success">${d.fg}</h4></div>
                    <div class="col"><h6>FPY</h6><h4 class="text-primary">${d.fpy}</h4></div>
                </div>
                <h6>Defect Details</h6>
                <table class="table table-sm table-striped"><thead><tr><th>Issue</th><th>Qty</th><th>Cause</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('prevModal')).show();
    }

    // --- 5. LOAD DATA & CHART ---
    function loadData() {
        fetch(API_URL).then(r => r.json()).then(data => {
            ALL_DATA = data;
            updateDash();
        });
    }

    function updateDash() {
        const sDate = document.getElementById('dashStart').value;
        const eDate = document.getElementById('dashEnd').value;
        
        // Filter logic
        const filtered = ALL_DATA.filter(d => {
            let dt = d.date.split('T')[0];
            return (!sDate || dt >= sDate) && (!eDate || dt <= eDate);
        });

        // Populate Table
        const tbody = document.querySelector('#recTable tbody');
        tbody.innerHTML = "";
        let totIn = 0, totDef = 0, totFg = 0;
        let defectMap = {};

        filtered.forEach(d => {
            totIn += (+d.input || 0);
            totFg += (+d.fg || 0);
            
            // Parse Defects for Chart
            try {
                JSON.parse(d.defects).forEach(def => {
                    totDef += (+def.qty);
                    defectMap[def.name] = (defectMap[def.name] || 0) + (+def.qty);
                });
            } catch(e) {}

            tbody.innerHTML += `<tr>
                <td>${d.date.substring(0,10)}</td>
                <td>${d.model}</td>
                <td>${d.input}</td>
                <td>${d.fg}</td>
                <td>${d.fpy}</td>
                <td>
                   <button class="btn btn-sm btn-info text-white" onclick="editRec('${d.id}')"><i class="fas fa-edit"></i></button>
                   <button class="btn btn-sm btn-danger" onclick="deleteRecord('${d.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });

        // KPIs
        document.getElementById('k-input').innerText = totIn;
        document.getElementById('k-defects').innerText = totDef;
        document.getElementById('k-fpy').innerText = totIn ? ((totFg/totIn)*100).toFixed(1)+"%" : "0%";

        // Charts
        renderCharts(filtered, defectMap);
    }

    function editRec(id) {
        const r = ALL_DATA.find(x => x.id == id);
        if(!r) return;
        document.getElementById('recordId').value = r.id;
        document.getElementById('date').value = r.date.substring(0,10);
        document.getElementById('model').value = r.model;
        document.getElementById('inputQty').value = r.input;
        // Trigger Tab
        new bootstrap.Tab(document.querySelector('button[data-bs-target="#entryTab"]')).show();
        calcRates();
        alert("Record Loaded. Edit and Click Submit.");
    }

    let c1, c2;
    function renderCharts(rows, defs) {
        if(c1) c1.destroy();
        c1 = new Chart(document.getElementById('chartTrend'), {
            type: 'line',
            data: {
                labels: rows.map(r => r.date.substring(0,10)),
                datasets: [{ label: 'FPY %', data: rows.map(r => parseFloat(r.fpy)), borderColor: 'green', tension:0.3 }]
            }
        });

        const sorted = Object.entries(defs).sort((a,b)=>b[1]-a[1]).slice(0,5);
        if(c2) c2.destroy();
        c2 = new Chart(document.getElementById('chartPareto'), {
            type: 'bar',
            data: {
                labels: sorted.map(x=>x[0]),
                datasets: [{ label: 'Qty', data: sorted.map(x=>x[1]), backgroundColor: 'blue' }]
            }
        });
    }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('recTable'), {sheet:"Log"});
        XLSX.writeFile(wb, "Califonix_Report.xlsx");
    }

    function togglePDI() { document.getElementById('pdiSection').classList.toggle('hidden', !document.getElementById('pdiToggle').checked); }
    function calcPDI() { document.getElementById('pdiFail').value = (+document.getElementById('pdiOffer').value||0) - (+document.getElementById('pdiPass').value||0); }
    function resetForm() { document.getElementById('mainForm').reset(); document.querySelector('#prodTable tbody').innerHTML=''; }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
