<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Smart Dashboard</title>
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
     
    <style>
        :root { --primary-color: #0d6efd; --bg-color: #f4f6f9; }
        body { background: var(--bg-color); font-family: 'Segoe UI', Roboto, sans-serif; font-size: 0.9rem; }
        
        /* Navbar & Tabs */
        .navbar { background: white; border-bottom: 3px solid var(--primary-color); }
        .nav-tabs .nav-link { color: #555; font-weight: 600; border: none; }
        .nav-tabs .nav-link.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: transparent; }
        
        /* Cards & Sections */
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-head { background: #eef2f7; color: #333; padding: 10px 15px; border-radius: 8px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Utility */
        .hidden { display: none !important; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .kpi-card { text-align: center; padding: 15px; border-radius: 8px; color: white; }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }

        /* Floating AI Button */
        .ai-btn { cursor: pointer; color: #6f42c1; font-weight: bold; font-size: 0.8rem; margin-left: 5px; border: 1px solid #6f42c1; padding: 2px 8px; border-radius: 12px; transition: 0.3s; }
        .ai-btn:hover { background: #6f42c1; color: white; }
    </style>
</head>
<body>

<!-- === NAVBAR === -->
<nav class="navbar navbar-expand-lg px-4 sticky-top shadow-sm">
    <div class="d-flex align-items-center">
        <!-- LOGO HERE -->
        <img id="navLogo" src="" style="height: 45px;" class="me-3" alt="Logo">
        <h5 class="text-primary fw-bold mb-0">Production & PDI System</h5>
    </div>
    <div class="ms-auto">
        <ul class="nav nav-tabs border-0" id="mainTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#entryTab">üìù Data Entry</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#prodDashTab" onclick="loadData('PROD')">üè≠ Production Dashboard</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pdiDashTab" onclick="loadData('PDI')">üõ°Ô∏è PDI Dashboard</button></li>
        </ul>
    </div>
</nav>

<div class="container-fluid mt-4 px-4 pb-5 tab-content">

    <!-- ========================= 1. DATA ENTRY TAB ========================= -->
    <div class="tab-pane fade show active" id="entryTab">
        <form id="mainForm">
            <input type="hidden" id="recordId"> <!-- For Edit Mode -->
            
            <!-- SECTION A: Production -->
            <div class="card">
                <div class="card-body">
                    <div class="section-head">
                        <span>1. Production Details</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetForm()">üîÑ Reset Form</button>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-2"><label>Date</label><input type="date" id="date" class="form-control"></div>
                        <div class="col-md-2"><label>Line / Machine</label><select id="line" class="form-select"><option>Line 1</option><option>Line 2</option><option>Line 3</option></select></div>
                        <div class="col-md-2"><label>Model</label><input type="text" id="model" class="form-control" placeholder="Ex: Dashcam X1"></div>
                        <div class="col-md-2"><label>Input Qty</label><input type="number" id="inputQty" class="form-control" oninput="calcRates()"></div>
                        <div class="col-md-2"><label>FG Qty (Pass)</label><input type="number" id="fgQty" class="form-control" oninput="calcRates()"></div>
                        <div class="col-md-2">
                            <label>FPY %</label>
                            <input type="text" id="fpyRate" class="form-control fw-bold text-success" readonly>
                        </div>
                    </div>

                    <!-- Defect Table -->
                    <div class="mt-4">
                        <h6 class="fw-bold text-danger">Defect / Rejection Details</h6>
                        <table class="table table-bordered table-hover align-middle" id="prodTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="20%">Defect Name</th>
                                    <th width="10%">Qty</th>
                                    <th width="15%">Type</th>
                                    <th width="20%">Root Cause</th>
                                    <th width="30%">Action Plan <small class="text-muted">(AI Assisted)</small></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProdRow()">+ Add Defect</button>
                    </div>
                    
                    <div class="row g-3 mt-2">
                        <div class="col-md-3 ms-auto">
                            <label>RMD Rejection %</label><input type="text" id="rmdRate" class="form-control fw-bold" readonly>
                        </div>
                        <div class="col-md-3">
                            <label>Process Rejection %</label><input type="text" id="procRate" class="form-control fw-bold text-danger" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION B: PDI -->
            <div class="card">
                <div class="card-body">
                    <div class="section-head">
                        <span>2. PDI Performance</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pdiToggle" onchange="togglePDI()">
                            <label class="form-check-label fw-normal">Enable PDI Entry</label>
                        </div>
                    </div>

                    <div id="pdiSection" class="hidden">
                        <div class="row g-3">
                            <div class="col-md-3"><label>PDI Offered</label><input type="number" id="pdiOffer" class="form-control" oninput="calcPDI()"></div>
                            <div class="col-md-3"><label>PDI Passed</label><input type="number" id="pdiPass" class="form-control" oninput="calcPDI()"></div>
                            <div class="col-md-3"><label>PDI Failed</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                            <div class="col-md-3"><label>PDI Pass Rate</label><input type="text" id="pdiRate" class="form-control text-success fw-bold" readonly></div>
                        </div>

                        <!-- PDI Issues -->
                        <div id="pdiFailDetails" class="mt-4 hidden p-3 bg-white border rounded">
                            <h6 class="text-danger fw-bold">‚ö†Ô∏è PDI Failure Breakdown</h6>
                            <table class="table table-sm table-bordered">
                                <thead class="table-danger"><tr><th>Category</th><th>Issue Detail</th><th>Qty</th><th>Root Cause</th><th>Action (AI)</th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td>Function</td>
                                        <td><input type="text" id="pfd" class="form-control"></td>
                                        <td><input type="number" id="pfq" class="form-control" value="0"></td>
                                        <td><input type="text" id="pfc" class="form-control"></td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" id="pfa" class="form-control">
                                                <span class="input-group-text ai-btn" onclick="aiRewrite('pfa')">‚ú® AI</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Aesthetic</td>
                                        <td><input type="text" id="pad" class="form-control"></td>
                                        <td><input type="number" id="paq" class="form-control" value="0"></td>
                                        <td><input type="text" id="pac" class="form-control"></td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" id="paa" class="form-control">
                                                <span class="input-group-text ai-btn" onclick="aiRewrite('paa')">‚ú® AI</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Packing</td>
                                        <td><input type="text" id="ppd" class="form-control"></td>
                                        <td><input type="number" id="ppq" class="form-control" value="0"></td>
                                        <td><input type="text" id="ppc" class="form-control"></td>
                                        <td>
                                            <div class="input-group">
                                                <input type="text" id="ppa" class="form-control">
                                                <span class="input-group-text ai-btn" onclick="aiRewrite('ppa')">‚ú® AI</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center py-3">
                <button type="button" class="btn btn-dark btn-lg px-5" onclick="showPreview()">üëÅÔ∏è Preview & Submit</button>
            </div>
        </form>
    </div>

    <!-- ========================= 2. PRODUCTION DASHBOARD ========================= -->
    <div class="tab-pane fade" id="prodDashTab">
        <!-- Filters -->
        <div class="card p-3 mb-3">
            <div class="row align-items-end g-2">
                <div class="col-md-2"><label>Start Date</label><input type="date" id="prodStart" class="form-control"></div>
                <div class="col-md-2"><label>End Date</label><input type="date" id="prodEnd" class="form-control"></div>
                <div class="col-md-2"><label>Model</label><select id="prodModelFilter" class="form-select"><option value="All">All Models</option></select></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="updateProdDash()">üîé Apply Filter</button></div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row mb-4">
            <div class="col-md-3"><div class="kpi-card bg-gradient-success"><h5>Avg FPY</h5><h2 id="kpi-fpy">0%</h2></div></div>
            <div class="col-md-3"><div class="kpi-card bg-gradient-danger"><h5>Process Rejection</h5><h2 id="kpi-proc">0%</h2></div></div>
            <div class="col-md-3"><div class="kpi-card bg-gradient-warning"><h5>RMD Rejection</h5><h2 id="kpi-rmd">0%</h2></div></div>
            <div class="col-md-3"><div class="kpi-card bg-gradient-primary"><h5>Total Production</h5><h2 id="kpi-vol">0</h2></div></div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-8">
                <div class="card p-3">
                    <h6 class="fw-bold">üìà Trend Analysis (FPY vs Rejection)</h6>
                    <div class="chart-container"><canvas id="prodTrendChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h6 class="fw-bold">üìä Pareto Analysis (Top 5 Defects)</h6>
                    <div class="chart-container"><canvas id="prodParetoChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Top Issues Report -->
        <div class="card p-3 mt-3">
            <h6 class="fw-bold">üìã Top 5 Issues Report (Cause & Action)</h6>
            <div class="table-responsive">
                <table class="table table-bordered table-sm" id="topIssuesTable">
                    <thead class="table-light"><tr><th>Issue</th><th>Count</th><th>Common Cause</th><th>Action Taken</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Records Table (CRUD) -->
        <div class="card p-3 mt-3">
            <h6 class="fw-bold">üìù Production Records (Edit/Delete)</h6>
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="prodListTable">
                    <thead class="table-dark"><tr><th>Date</th><th>Model</th><th>Input</th><th>FG</th><th>FPY</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========================= 3. PDI DASHBOARD ========================= -->
    <div class="tab-pane fade" id="pdiDashTab">
        <div class="card p-3 mb-3">
            <div class="row align-items-end g-2">
                <div class="col-md-3"><label>Month Selection</label><input type="month" id="pdiMonth" class="form-control" onchange="updatePDIDash()"></div>
                <div class="col-md-3"><button class="btn btn-primary" onclick="updatePDIDash()">Refresh View</button></div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4"><div class="kpi-card bg-gradient-primary"><h5>PDI Offered</h5><h2 id="p-off">0</h2></div></div>
            <div class="col-md-4"><div class="kpi-card bg-gradient-success"><h5>PDI Passed</h5><h2 id="p-pass">0</h2></div></div>
            <div class="col-md-4"><div class="kpi-card bg-gradient-danger"><h5>Avg Failure Rate</h5><h2 id="p-failRate">0%</h2></div></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3"><h6 class="fw-bold">PDI Failure Trend</h6><div class="chart-container"><canvas id="pdiTrendChart"></canvas></div></div>
            </div>
            <div class="col-md-6">
                <div class="card p-3"><h6 class="fw-bold">Category Wise Defects</h6><div class="chart-container"><canvas id="pdiPieChart"></canvas></div></div>
            </div>
        </div>
        
        <!-- PDI Records -->
        <div class="card p-3 mt-3">
            <h6 class="fw-bold">üìù PDI Records History</h6>
             <table class="table table-striped table-sm" id="pdiListTable">
                <thead class="table-dark"><tr><th>Date</th><th>Model</th><th>Offer</th><th>Pass</th><th>Fail Details</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="prevModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">Confirm Submission</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="prevContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button class="btn btn-success" id="finalBtn" onclick="submitData()">‚úÖ Submit Data</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png"; //
    const API_URL = "https://script.google.com/macros/s/AKfycbzEgdlCLOOe0ZqL-A5UUcGiWxGKOuepl76a2S98XhSVHJQolj44sKmkc67C4ffqDsTnuw/exec"; // ‡§Ü‡§™‡§ï‡•Ä Script URL
    const GEMINI_API_KEY = ""; // üî¥ AI ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å API Key ‡§°‡§æ‡§≤‡•á‡§Ç (Google AI Studio ‡§∏‡•á ‡§´‡•ç‡§∞‡•Ä ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à)

    document.getElementById('navLogo').src = LOGO_URL;
    document.getElementById('date').valueAsDate = new Date();

    let ALL_DATA = []; // Store fetched data locally

    // --- 1. AI REWRITE FUNCTION ---
    async function aiRewrite(inputId) {
        if(!GEMINI_API_KEY) { alert("Please set the GEMINI_API_KEY in the code first."); return; }
        
        const inputField = document.getElementById(inputId);
        const originalText = inputField.value;
        if(!originalText) { alert("Please write something first!"); return; }

        inputField.value = "AI rewriting...";
        inputField.disabled = true;

        const prompt = `Rewrite this manufacturing action plan to be professional, clear, and concise in English: "${originalText}"`;
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            const newText = data.candidates[0].content.parts[0].text;
            inputField.value = newText;
        } catch(e) {
            alert("AI Error: " + e.message);
            inputField.value = originalText;
        }
        inputField.disabled = false;
    }

    // --- 2. CALCULATIONS ---
    function calcRates() {
        const inp = +document.getElementById('inputQty').value || 0;
        const fg = +document.getElementById('fgQty').value || 0;
        
        // FPY
        document.getElementById('fpyRate').value = inp ? ((fg/inp)*100).toFixed(1) + "%" : "0%";

        // Defect Rates
        let procQ = 0, rmdQ = 0;
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            const q = +r.querySelector('.d-qty').value || 0;
            const t = r.querySelector('.d-type').value;
            if(t === 'Process') procQ += q; else rmdQ += q;
        });

        document.getElementById('procRate').value = inp ? ((procQ/inp)*100).toFixed(1) + "%" : "0%";
        document.getElementById('rmdRate').value = inp ? ((rmdQ/inp)*100).toFixed(1) + "%" : "0%";
    }

    function addProdRow() {
        const id = 'act_' + Math.random().toString(36).substr(2, 5);
        document.querySelector('#prodTable tbody').insertAdjacentHTML('beforeend', `
            <tr>
                <td><input type="text" class="form-control d-name" placeholder="Defect Name"></td>
                <td><input type="number" class="form-control d-qty" oninput="calcRates()"></td>
                <td><select class="form-select d-type" onchange="calcRates()"><option>Process</option><option>RMD</option></select></td>
                <td><input type="text" class="form-control d-cause" placeholder="Why?"></td>
                <td>
                    <div class="input-group">
                        <input type="text" class="form-control d-action" id="${id}" placeholder="Corrective Action">
                        <span class="input-group-text ai-btn" onclick="aiRewrite('${id}')">‚ú® AI</span>
                    </div>
                </td>
                <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcRates()"><i class="fas fa-trash"></i></button></td>
            </tr>
        `);
    }

    function togglePDI() {
        const on = document.getElementById('pdiToggle').checked;
        document.getElementById('pdiSection').classList.toggle('hidden', !on);
    }

    function calcPDI() {
        const off = +document.getElementById('pdiOffer').value || 0;
        const pass = +document.getElementById('pdiPass').value || 0;
        const fail = off - pass;
        
        document.getElementById('pdiFail').value = fail;
        document.getElementById('pdiRate').value = off ? ((pass/off)*100).toFixed(1)+"%" : "0%";
        
        document.getElementById('pdiFailDetails').classList.toggle('hidden', fail <= 0);
    }

    // --- 3. PREVIEW & SUBMIT ---
    function showPreview() {
        // Simple HTML Preview Construction
        const date = document.getElementById('date').value;
        const model = document.getElementById('model').value;
        const fpy = document.getElementById('fpyRate').value;
        
        let html = `<h6><b>Date:</b> ${date} | <b>Model:</b> ${model} | <b>FPY:</b> ${fpy}</h6><hr>`;
        html += `<p><b>Defects:</b></p><ul>`;
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            html += `<li>${r.querySelector('.d-name').value} (Qty: ${r.querySelector('.d-qty').value})</li>`;
        });
        html += `</ul>`;
        
        document.getElementById('prevContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('prevModal')).show();
    }

    function submitData() {
        const btn = document.getElementById('finalBtn');
        btn.innerText = "Sending..."; btn.disabled = true;

        // Collect Defect Data
        let defects = [];
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            defects.push({
                name: r.querySelector('.d-name').value,
                qty: r.querySelector('.d-qty').value,
                type: r.querySelector('.d-type').value,
                cause: r.querySelector('.d-cause').value,
                action: r.querySelector('.d-action').value
            });
        });

        const payload = {
            id: document.getElementById('recordId').value || new Date().getTime(), // Unique ID
            date: document.getElementById('date').value,
            line: document.getElementById('line').value,
            model: document.getElementById('model').value,
            input: document.getElementById('inputQty').value,
            fg: document.getElementById('fgQty').value,
            fpy: document.getElementById('fpyRate').value,
            procRate: document.getElementById('procRate').value,
            rmdRate: document.getElementById('rmdRate').value,
            defects: JSON.stringify(defects), // Save as JSON string
            // PDI Data
            pdiOffer: document.getElementById('pdiToggle').checked ? document.getElementById('pdiOffer').value : 0,
            pdiPass: document.getElementById('pdiPass').value,
            pdiFail: document.getElementById('pdiFail').value,
            pdiDetails: JSON.stringify({
                 func: { d: document.getElementById('pfd').value, q: document.getElementById('pfq').value, c: document.getElementById('pfc').value, a: document.getElementById('pfa').value },
                 aes: { d: document.getElementById('pad').value, q: document.getElementById('paq').value, c: document.getElementById('pac').value, a: document.getElementById('paa').value },
                 pack: { d: document.getElementById('ppd').value, q: document.getElementById('ppq').value, c: document.getElementById('ppc').value, a: document.getElementById('ppa').value }
            })
        };

        // Sending to Google Sheet
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // standard for GAS
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Data Submitted Successfully!");
            location.reload();
        }).catch(e => alert("Error: "+e));
    }

    // --- 4. DATA LOADING & DASHBOARD ---
    function loadData(type) {
        if(ALL_DATA.length > 0) { 
            if(type === 'PROD') updateProdDash(); 
            else updatePDIDash(); 
            return; 
        }

        fetch(API_URL).then(r => r.json()).then(data => {
            ALL_DATA = data; // Assuming data is array of objects from Sheet
            // Map columns based on your sheet structure. This is a mockup map:
            // Assuming Sheet has headers matching keys or we map index. 
            // For this demo, I assume the API returns objects matching payload keys.
            
            if(type === 'PROD') updateProdDash();
            else updatePDIDash();
        }).catch(e => console.error("Load Error", e));
    }

    // --- PRODUCTION DASHBOARD LOGIC ---
    let chart1, chart2;
    function updateProdDash() {
        const sDate = document.getElementById('prodStart').value;
        const eDate = document.getElementById('prodEnd').value;
        
        // Filter Data
        const filtered = ALL_DATA.filter(d => {
            // Note: Adjust property names based on your actual Google Sheet response
            let rowDate = d.date || d[1]; // fallback to index if needed
            return (!sDate || rowDate >= sDate) && (!eDate || rowDate <= eDate);
        });

        // 1. Calculate KPIs
        let totalInp = 0, totalFG = 0;
        let defectCounts = {};
        
        filtered.forEach(d => {
            totalInp += (+d.input || 0);
            totalFG += (+d.fg || 0);
            
            // Parse Defects
            try {
                let defs = JSON.parse(d.defects || "[]");
                defs.forEach(def => {
                    if(!defectCounts[def.name]) defectCounts[def.name] = { qty: 0, cause: def.cause, action: def.action };
                    defectCounts[def.name].qty += (+def.qty);
                });
            } catch(e){}
        });

        document.getElementById('kpi-vol').innerText = totalInp;
        document.getElementById('kpi-fpy').innerText = totalInp ? ((totalFG/totalInp)*100).toFixed(1)+"%" : "0%";

        // 2. Charts
        // Trend Chart (Line)
        const labels = filtered.map(d => d.date);
        const fpyData = filtered.map(d => parseFloat(d.fpy));
        const procData = filtered.map(d => parseFloat(d.procRate));

        if(chart1) chart1.destroy();
        chart1 = new Chart(document.getElementById('prodTrendChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'FPY %', data: fpyData, borderColor: 'green', tension: 0.3 },
                    { label: 'Process Rejection %', data: procData, borderColor: 'red', tension: 0.3 }
                ]
            }
        });

        // Pareto Chart (Bar + Line)
        const sortedDefects = Object.entries(defectCounts).sort((a,b) => b[1].qty - a[1].qty).slice(0, 5);
        
        if(chart2) chart2.destroy();
        chart2 = new Chart(document.getElementById('prodParetoChart'), {
            type: 'bar',
            data: {
                labels: sortedDefects.map(x => x[0]),
                datasets: [{
                    label: 'Defect Qty',
                    data: sortedDefects.map(x => x[1].qty),
                    backgroundColor: '#0d6efd'
                }]
            }
        });

        // 3. Top Issues Report
        const tbody = document.querySelector('#topIssuesTable tbody');
        tbody.innerHTML = "";
        sortedDefects.forEach(([name, details]) => {
            tbody.innerHTML += `<tr><td>${name}</td><td>${details.qty}</td><td>${details.cause || '-'}</td><td>${details.action || '-'}</td></tr>`;
        });

        // 4. Records List (CRUD)
        const listBody = document.querySelector('#prodListTable tbody');
        listBody.innerHTML = "";
        filtered.forEach((d, idx) => {
            listBody.innerHTML += `
                <tr>
                    <td>${d.date}</td><td>${d.model}</td><td>${d.input}</td><td>${d.fg}</td><td>${d.fpy}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick="editRecord('${d.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('${d.id}')">Delete</button>
                    </td>
                </tr>`;
        });
    }

    // --- PDI DASHBOARD LOGIC (SIMPLIFIED) ---
    let chart3, chart4;
    function updatePDIDash() {
        // Logic similar to Prod Dash but filtering for PDI fields
        // Populate pdiTrendChart and pdiPieChart
        // Populate pdiListTable
    }

    // --- CRUD FUNCTIONS ---
    function deleteRecord(id) {
        if(!confirm("Are you sure? This will delete the record.")) return;
        // NOTE: Google Apps Script needs to handle 'action=delete'
        fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ action: 'delete', id: id })
        }).then(() => { alert("Deleted (Refresh to see changes)"); loadData('PROD'); });
    }

    function editRecord(id) {
        const rec = ALL_DATA.find(r => r.id == id);
        if(!rec) return;
        
        // Switch to Entry Tab
        new bootstrap.Tab(document.querySelector('button[data-bs-target="#entryTab"]')).show();
        
        // Populate Form
        document.getElementById('recordId').value = rec.id;
        document.getElementById('date').value = rec.date;
        document.getElementById('model').value = rec.model;
        document.getElementById('inputQty').value = rec.input;
        document.getElementById('fgQty').value = rec.fg;
        calcRates();
        // Populate defects logic would go here...
        
        alert("Record Loaded for Editing. Click Submit to Update.");
    }

    function resetForm() {
        document.getElementById('mainForm').reset();
        document.querySelector('#prodTable tbody').innerHTML = "";
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
