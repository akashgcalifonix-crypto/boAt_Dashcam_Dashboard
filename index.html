<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Suite</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .nav-tabs .nav-link.active { background-color: #0d6efd; color: white; border:none; border-radius: 5px 5px 0 0; }
        .section-head { background: #e9ecef; border-left: 5px solid #0d6efd; padding: 10px; font-weight: bold; margin: 20px 0 10px 0; }
        .hidden { display: none; }
        .chart-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .logo-img { height: 50px; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<!-- NAVIGATION -->
<nav class="navbar navbar-light bg-white shadow-sm px-4 no-print">
    <div class="d-flex align-items-center">
        <!-- LOGO PLACEHOLDER - Change src in Script below -->
        <img id="navLogo" src="" class="logo-img me-3">
        <h4 class="text-primary fw-bold mb-0">Quality Management System</h4>
    </div>
    <ul class="nav nav-pills">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#entryTab">üìù Data Entry</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dashTab" onclick="loadDashboard()">üìä Analytics Dashboard</a></li>
    </ul>
</nav>

<div class="container mt-4 pb-5 tab-content">

    <!-- === TAB 1: DATA ENTRY === -->
    <div class="tab-pane fade show active" id="entryTab">
        <form id="mainForm">
            
            <!-- 1. Production Info -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="section-head mt-0">1. Production Details</div>
                    <div class="row g-3">
                        <div class="col-md-3"><label>Date</label><input type="date" id="date" class="form-control"></div>
                        <div class="col-md-3"><label>Model</label><input type="text" id="model" class="form-control"></div>
                        <div class="col-md-3"><label>Colour</label><input type="text" id="colour" class="form-control"></div>
                        <div class="col-md-3"><label>Input Qty</label><input type="number" id="inputQty" class="form-control"></div>
                        <div class="col-md-3"><label>FG Qty (Manual)</label><input type="number" id="fgQty" class="form-control"></div>
                        <div class="col-md-3"><label>Total Defect Qty</label><input type="number" id="defectQty" class="form-control" oninput="calcRates()"></div>
                        <div class="col-md-3"><label>Defect Rate %</label><input type="text" id="defectRate" class="form-control fw-bold text-danger" readonly></div>
                    </div>

                    <!-- Production Defects (Dynamic) -->
                    <div class="section-head">2. Production Defect Bifurcation</div>
                    <table class="table table-bordered table-sm" id="prodTable">
                        <thead class="table-light"><tr><th>Defect Name</th><th>Qty</th><th>Type</th><th>Cause</th><th>Action</th><th>Remove</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProdRow()">+ Add Defect</button>
                </div>
            </div>

            <!-- 2. PDI Details -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <div class="section-head mt-0">3. PDI Performance</div>
                    <div class="row g-3">
                        <div class="col-md-3"><label>PDI Offer</label><input type="number" id="pdiOffer" class="form-control" oninput="calcPDI()"></div>
                        <div class="col-md-3"><label>PDI Pass</label><input type="number" id="pdiPass" class="form-control" oninput="calcPDI()"></div>
                        <div class="col-md-3"><label>PDI Fail</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                        <div class="col-md-3"><label>PDI Rate %</label><input type="text" id="pdiRate" class="form-control" readonly></div>
                    </div>

                    <!-- PDI FAILURE LOGIC (Opened on Fail > 0) -->
                    <div id="pdiFailSection" class="hidden mt-4 border border-danger p-3 rounded bg-white">
                        <h5 class="text-danger border-bottom pb-2">‚ö†Ô∏è PDI Failure Analysis (CAPA)</h5>
                        
                        <!-- Fixed PDI Categories -->
                        <table class="table table-bordered align-middle">
                            <thead class="table-danger"><tr><th>Category</th><th>Qty</th><th>Root Cause Analysis</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td><strong>1. Function</strong></td>
                                    <td><input type="number" id="pfq" class="form-control" placeholder="0"></td>
                                    <td><input type="text" id="pfc" class="form-control" placeholder="Cause"></td>
                                </tr>
                                <tr>
                                    <td><strong>2. Aesthetic</strong></td>
                                    <td><input type="number" id="paq" class="form-control" placeholder="0"></td>
                                    <td><input type="text" id="pac" class="form-control" placeholder="Cause"></td>
                                </tr>
                                <tr>
                                    <td><strong>3. Packing</strong></td>
                                    <td><input type="number" id="ppq" class="form-control" placeholder="0"></td>
                                    <td><input type="text" id="ppc" class="form-control" placeholder="Cause"></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Traceability -->
                        <div class="row g-2 mt-3">
                            <div class="col-md-12 fw-bold text-primary">Traceability Info:</div>
                            <div class="col-md-3"><small>Master Carton Date</small><input type="datetime-local" id="mcDate" class="form-control"></div>
                            <div class="col-md-3"><small>LQC Date</small><input type="datetime-local" id="lqcDate" class="form-control"></div>
                            <div class="col-md-3"><small>LQC Operator</small><input type="text" id="lqcName" class="form-control"></div>
                            <div class="col-md-3"><small>Testing Operator</small><input type="text" id="testName" class="form-control"></div>
                        </div>

                        <!-- CAPA -->
                        <div class="row g-3 mt-3">
                            <div class="col-12"><label>Problem Description</label><input type="text" id="probDesc" class="form-control"></div>
                            <div class="col-md-4"><label>Root Cause</label><textarea id="rootCause" class="form-control"></textarea></div>
                            <div class="col-md-4"><label>Corrective Action</label><textarea id="corrAction" class="form-control"></textarea></div>
                            <div class="col-md-4"><label>Preventive Action</label><textarea id="prevAction" class="form-control"></textarea></div>
                            
                            <!-- Evidence Upload -->
                            <div class="col-12">
                                <label class="fw-bold">Upload Evidence (Images)</label>
                                <input type="file" id="evidFiles" class="form-control" multiple accept="image/*" onchange="previewImgs()">
                                <div id="previewBox" class="d-flex mt-2 gap-2 flex-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center gap-3 mt-4">
                <button type="button" class="btn btn-dark" onclick="showPreview()">üëÅÔ∏è Preview Data</button>
                <button type="button" class="btn btn-outline-success" onclick="downloadExcel()">üìó Excel</button>
                <button type="button" class="btn btn-primary" onclick="downloadPPT()">üìò PPT</button>
            </div>
        </form>
    </div>

    <!-- === TAB 2: ANALYTICS DASHBOARD === -->
    <div class="tab-pane fade" id="dashTab">
        <!-- Date Filter -->
        <div class="card p-3 mb-3 shadow-sm no-print">
            <div class="row align-items-end">
                <div class="col-md-4"><label>Start Date</label><input type="date" id="startDate" class="form-control"></div>
                <div class="col-md-4"><label>End Date</label><input type="date" id="endDate" class="form-control"></div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="loadDashboard()">Search / Refresh</button>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="chart-box text-center border-start border-5 border-success">
                    <h5 class="text-muted">First Pass Yield (FPY)</h5>
                    <h2 class="display-6 fw-bold text-success" id="dashFPY">0%</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-box text-center border-start border-5 border-danger">
                    <h5 class="text-muted">Process Defect Rate</h5>
                    <h2 class="display-6 fw-bold text-danger" id="dashDef">0%</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-box text-center border-start border-5 border-warning">
                    <h5 class="text-muted">Top Defect Issue</h5>
                    <h4 class="fw-bold text-dark mt-2" id="dashTop">-</h4>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-8">
                <div class="chart-box">
                    <h6 class="text-center">Daily FPY Trend</h6>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-box">
                    <h6 class="text-center">Defect Pareto</h6>
                    <canvas id="paretoChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
             <button class="btn btn-dark no-print" onclick="window.print()">üñ®Ô∏è Print Dashboard</button>
        </div>
    </div>

</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="prevModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">Confirm Data</h5></div>
            <div class="modal-body" id="prevContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button type="button" class="btn btn-success" id="finalSaveBtn" onclick="saveToCloud()">‚úÖ Submit to Database</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const LOGO_URL = "https://via.placeholder.com/180x50?text=CALIFONIX+LOGO"; // Yahan Apna Logo Link Dalein
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEymHfyzXG86tSHwxij6uTckGt2nPHrsHSO7aNVnPSOz5Abbz1MgUdFE4qVKfMg5Va-A/exec"; // STEP 1 wala URL yahan paste karein
    
    document.getElementById('navLogo').src = LOGO_URL;
    document.getElementById('date').valueAsDate = new Date();

    // --- CALCULATIONS ---
    function calcRates() {
        let inp = +document.getElementById('inputQty').value || 0;
        let def = +document.getElementById('defectQty').value || 0;
        document.getElementById('defectRate').value = inp ? ((def/inp)*100).toFixed(2) + "%" : "0%";
    }

    function calcPDI() {
        let offer = +document.getElementById('pdiOffer').value || 0;
        let pass = +document.getElementById('pdiPass').value || 0;
        let fail = offer - pass;
        
        document.getElementById('pdiFail').value = fail;
        document.getElementById('pdiRate').value = offer ? ((pass/offer)*100).toFixed(2) + "%" : "0%";

        const sec = document.getElementById('pdiFailSection');
        if(fail > 0) sec.classList.remove('hidden');
        else sec.classList.add('hidden');
    }

    // --- DYNAMIC ROWS ---
    function addProdRow() {
        const t = document.querySelector('#prodTable tbody');
        t.insertAdjacentHTML('beforeend', `<tr>
            <td><input type="text" class="form-control d-name"></td>
            <td><input type="number" class="form-control d-qty"></td>
            <td><select class="form-select d-type"><option>Process</option><option>RMD</option></select></td>
            <td><input type="text" class="form-control d-cause"></td>
            <td><input type="text" class="form-control d-action"></td>
            <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button></td>
        </tr>`);
    }

    // --- IMAGES ---
    let imgStore = [];
    function previewImgs() {
        const files = document.getElementById('evidFiles').files;
        const box = document.getElementById('previewBox');
        box.innerHTML = ""; imgStore = [];
        Array.from(files).forEach(f => {
            const r = new FileReader();
            r.onload = e => {
                imgStore.push(e.target.result);
                box.innerHTML += `<img src="${e.target.result}" style="height:60px; border:1px solid #ddd">`;
            };
            r.readAsDataURL(f);
        });
    }

    // --- PREVIEW & SAVE ---
    function showPreview() {
        let h = `<table class="table table-bordered">`;
        h += `<tr><th>Date</th><td>${document.getElementById('date').value}</td><th>Model</th><td>${document.getElementById('model').value}</td></tr>`;
        h += `<tr><th>PDI Fail</th><td>${document.getElementById('pdiFail').value}</td><th>Total Defect</th><td>${document.getElementById('defectQty').value}</td></tr>`;
        h += `</table>`;
        if(+document.getElementById('pdiFail').value > 0) {
            h += `<div class="alert alert-danger">Includes PDI Failure Details & Traceability</div>`;
        }
        document.getElementById('prevContent').innerHTML = h;
        new bootstrap.Modal(document.getElementById('prevModal')).show();
    }

    function saveToCloud() {
        const btn = document.getElementById('finalSaveBtn');
        btn.innerText = "Saving..."; btn.disabled = true;

        let prodDefects = [];
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            prodDefects.push({
                name: r.querySelector('.d-name').value,
                qty: r.querySelector('.d-qty').value,
                type: r.querySelector('.d-type').value
            });
        });

        const payload = {
            date: document.getElementById('date').value,
            model: document.getElementById('model').value,
            colour: document.getElementById('colour').value,
            inputQty: document.getElementById('inputQty').value,
            fgQty: document.getElementById('fgQty').value,
            defectQty: document.getElementById('defectQty').value,
            defectRate: document.getElementById('defectRate').value,
            prodDefects: prodDefects,
            pdiOffer: document.getElementById('pdiOffer').value,
            pdiPass: document.getElementById('pdiPass').value,
            pdiFail: document.getElementById('pdiFail').value,
            pdiRate: document.getElementById('pdiRate').value,
            pdiDetails: {
                func: { qty: document.getElementById('pfq').value, cause: document.getElementById('pfc').value },
                aes: { qty: document.getElementById('paq').value, cause: document.getElementById('pac').value },
                pack: { qty: document.getElementById('ppq').value, cause: document.getElementById('ppc').value }
            },
            trace: {
                mcDate: document.getElementById('mcDate').value,
                lqcDate: document.getElementById('lqcDate').value,
                lqcName: document.getElementById('lqcName').value,
                testName: document.getElementById('testName').value
            },
            capa: {
                prob: document.getElementById('probDesc').value,
                rca: document.getElementById('rootCause').value,
                ca: document.getElementById('corrAction').value,
                pa: document.getElementById('prevAction').value
            },
            images: imgStore
        };

        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Data Saved Successfully!");
            location.reload();
        }).catch(e => { alert("Error: " + e); btn.disabled = false; });
    }

    // --- DASHBOARD LOGIC ---
    let c1, c2;
    function loadDashboard() {
        fetch(SCRIPT_URL).then(r => r.json()).then(data => {
            // Filter Data
            const sDate = document.getElementById('startDate').value;
            const eDate = document.getElementById('endDate').value;
            
            let filtered = data.filter(r => {
                let d = r[1].split('T')[0]; // Date format fix
                return (!sDate || d >= sDate) && (!eDate || d <= eDate);
            });

            if(filtered.length === 0) { alert("No Data Found"); return; }

            // Calcs
            let labels = [], fpyData = [];
            let defects = {};
            
            filtered.forEach(r => {
                labels.push(new Date(r[1]).toLocaleDateString());
                let inp = r[4], fg = r[5];
                fpyData.push(inp ? (fg/inp)*100 : 0);
                
                // Parse Defects (Col 8)
                try {
                    let dArr = JSON.parse(r[8]);
                    dArr.forEach(x => defects[x.name] = (defects[x.name] || 0) + (+x.qty));
                } catch(e){}
            });

            // Update UI
            let avg = fpyData.reduce((a,b)=>a+b,0)/fpyData.length;
            document.getElementById('dashFPY').innerText = avg.toFixed(1) + "%";
            
            // Charts
            if(c1) c1.destroy();
            c1 = new Chart(document.getElementById('trendChart'), {
                type: 'line', data: { labels: labels, datasets: [{ label:'FPY %', data: fpyData, borderColor:'green' }] }
            });

            let sortD = Object.entries(defects).sort((a,b)=>b[1]-a[1]).slice(0,5);
            document.getElementById('dashTop').innerText = sortD.length ? sortD[0][0] : "-";

            if(c2) c2.destroy();
            c2 = new Chart(document.getElementById('paretoChart'), {
                type: 'bar', data: { labels: sortD.map(x=>x[0]), datasets: [{ label:'Qty', data: sortD.map(x=>x[1]), backgroundColor:'red' }] }
            });
        });
    }

    // --- PPT EXPORT ---
    function downloadPPT() {
        let pres = new PptxGenJS();
        let slide = pres.addSlide();
        
        // Header
        slide.addText("CALIFONIX Quality Report", { x:0.5, y:0.5, fontSize:24, bold:true, color:'0d6efd' });
        slide.addText(`Date: ${document.getElementById('date').value}`, { x:0.5, y:1.0 });

        // Defect Table
        let rows = [['Category', 'Qty', 'Cause']];
        rows.push(['Function', document.getElementById('pfq').value, document.getElementById('pfc').value]);
        rows.push(['Aesthetic', document.getElementById('paq').value, document.getElementById('pac').value]);
        
        slide.addTable(rows, { x:0.5, y:2.0, w:8, border:{pt:1} });

        // Images
        if(imgStore.length > 0) {
            let slide2 = pres.addSlide();
            slide2.addText("Evidence", { x:0.5, y:0.5, fontSize:18, bold:true });
            slide2.addImage({ data:imgStore[0], x:1, y:1.5, w:4, h:3 });
        }

        pres.writeFile({ fileName: `Califonix_Report.pptx` });
    }

    function downloadExcel() {
        const data = [{
            Date: document.getElementById('date').value,
            Model: document.getElementById('model').value,
            Input: document.getElementById('inputQty').value,
            FG: document.getElementById('fgQty').value,
            DefectRate: document.getElementById('defectRate').value,
            PDIFail: document.getElementById('pdiFail').value
        }];
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, "Report.xlsx");
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
