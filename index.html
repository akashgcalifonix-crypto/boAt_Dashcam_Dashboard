<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Dashboard Pro</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
     
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: #fff; border-bottom: 3px solid #0d6efd; padding: 10px 20px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .kpi-box { padding: 20px; border-radius: 8px; color: white; text-align: center; }
        .bg-blue { background: linear-gradient(45deg, #007bff, #0056b3); }
        .bg-green { background: linear-gradient(45deg, #28a745, #1e7e34); }
        .bg-red { background: linear-gradient(45deg, #dc3545, #bd2130); }
        .preview-content { border: 2px solid #0d6efd; padding: 20px; background: #fff; border-radius: 8px; }
        .ai-btn { background: #6f42c1; color: white; border: none; border-radius: 20px; font-size: 12px; padding: 2px 10px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg sticky-top">
    <div class="d-flex align-items-center">
        <img id="navLogo" src="" style="height: 45px;" class="me-3">
        <h5 class="text-primary fw-bold m-0">Califonix Production System</h5>
    </div>
    <div class="ms-auto">
        <ul class="nav nav-pills">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#entryTab">üìù Data Entry</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashTab" onclick="loadDashboard()">üìä Dashboard</button></li>
        </ul>
    </div>
</nav>

<div class="container-fluid mt-4 pb-5 tab-content">

    <!-- TAB 1: DATA ENTRY -->
    <div class="tab-pane fade show active" id="entryTab">
        <form id="mainForm">
            <input type="hidden" id="recordId"> <!-- Hidden ID for Edit Mode -->
            
            <div class="card p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="fw-bold text-primary"><i class="fas fa-industry"></i> Production Details</h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetForm()">üîÑ Clear Form</button>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-2"><label>Date</label><input type="date" id="date" class="form-control"></div>
                    <div class="col-md-2"><label>Line</label><select id="line" class="form-select"><option>Line 1</option><option>Line 2</option><option>Line 3</option></select></div>
                    <div class="col-md-2"><label>Model</label><input type="text" id="model" class="form-control" placeholder="Model Name"></div>
                    <div class="col-md-2"><label>Input Qty</label><input type="number" id="inputQty" class="form-control" oninput="calcRates()"></div>
                    <div class="col-md-2"><label>FG (Pass)</label><input type="number" id="fgQty" class="form-control fw-bold text-success" readonly></div>
                    <div class="col-md-2"><label>FPY %</label><input type="text" id="fpyRate" class="form-control fw-bold text-primary" readonly></div>
                </div>

                <!-- Defects Table -->
                <div class="mt-4 p-3 bg-light rounded border">
                    <h6 class="fw-bold text-danger">‚ö†Ô∏è Defect Entry</h6>
                    <table class="table table-bordered bg-white" id="prodTable">
                        <thead><tr><th>Defect</th><th>Qty</th><th>Type</th><th>Cause</th><th>Action (AI)</th><th>Remove</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addDefectRow()">+ Add Defect</button>
                </div>
            </div>

            <!-- PDI Toggle -->
            <div class="card p-3">
                <div class="d-flex justify-content-between">
                    <h5 class="fw-bold"><i class="fas fa-shield-alt"></i> PDI Section</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="pdiToggle" onchange="togglePDI()">
                        <label class="form-check-label">Enable PDI</label>
                    </div>
                </div>
                <div id="pdiSection" class="hidden mt-3">
                    <div class="row g-3">
                        <div class="col-md-3"><label>Offered</label><input type="number" id="pdiOffer" class="form-control" oninput="calcPDI()"></div>
                        <div class="col-md-3"><label>Passed</label><input type="number" id="pdiPass" class="form-control" oninput="calcPDI()"></div>
                        <div class="col-md-3"><label>Failed</label><input type="number" id="pdiFail" class="form-control text-danger fw-bold" readonly></div>
                    </div>
                    <div class="mt-3">
                         <label>PDI Failure Note</label>
                         <div class="input-group">
                             <input type="text" id="pdiNote" class="form-control" placeholder="Reason for failure...">
                             <button class="ai-btn" type="button" onclick="aiRewrite('pdiNote')">‚ú® AI Fix</button>
                         </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-3">
                <button type="button" class="btn btn-dark btn-lg shadow" onclick="showPreview()">üëÅÔ∏è Preview & Submit</button>
            </div>
        </form>
    </div>

    <!-- TAB 2: DASHBOARD -->
    <div class="tab-pane fade" id="dashTab">
        <div class="card p-3">
            <div class="row align-items-end g-2">
                <div class="col-md-3"><label>Start Date</label><input type="date" id="dStart" class="form-control"></div>
                <div class="col-md-3"><label>End Date</label><input type="date" id="dEnd" class="form-control"></div>
                <div class="col-md-2"><label>Line</label><select id="dLine" class="form-select"><option value="All">All Lines</option><option>Line 1</option><option>Line 2</option><option>Line 3</option></select></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="loadDashboard()">Filter</button></div>
                <div class="col-md-2"><button class="btn btn-success w-100" onclick="exportData()">Download Excel</button></div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row mb-4">
            <div class="col-md-4"><div class="kpi-box bg-blue"><h3>Total Input</h3><h1 id="k-input">0</h1></div></div>
            <div class="col-md-4"><div class="kpi-box bg-green"><h3>Avg FPY</h3><h1 id="k-fpy">0%</h1></div></div>
            <div class="col-md-4"><div class="kpi-box bg-red"><h3>Total Defects</h3><h1 id="k-defects">0</h1></div></div>
        </div>

        <div class="row">
            <div class="col-md-8"><div class="card p-3"><h6>Trend Analysis</h6><canvas id="chartLine" style="height:300px"></canvas></div></div>
            <div class="col-md-4"><div class="card p-3"><h6>Pareto Analysis</h6><canvas id="chartBar" style="height:300px"></canvas></div></div>
        </div>

        <!-- Data Table (CRUD) -->
        <div class="card p-3 mt-3">
            <h5 class="fw-bold">Records History</h5>
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="crudTable">
                    <thead class="table-dark"><tr><th>Date</th><th>Line</th><th>Model</th><th>Input</th><th>FG</th><th>FPY</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="prevModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="prevBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                <button class="btn btn-success" id="btnSubmit" onclick="submitData()">‚úÖ Confirm Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= CONFIGURATION =================
    // üî¥ 1. ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ ‡§®‡§Ø‡§æ Deployment URL ‡§°‡§æ‡§≤‡•á‡§Ç
    const API_URL = "https://script.google.com/macros/s/AKfycbySG76uu47AUQ1JwKOTMGK_C4E22p2f8SvdhexII8cCYohvCM__oTbCtKtns9qNwb5qJw/exec"; 
    
    // üî¥ 2. ‡§Ø‡§π‡§æ‡§Å Logo Link ‡§î‡§∞ AI Key ‡§°‡§æ‡§≤‡•á‡§Ç
    const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png"; 
    const GEMINI_API_KEY = "AIzaSyDwFbj25ROQX52IzObhVIW_6t61O5TC2pA"; 

    // ==================================================

    document.getElementById('navLogo').src = LOGO_URL;
    document.getElementById('date').valueAsDate = new Date();
    let GLOBAL_DATA = [];

    // --- 1. AI REWRITE ---
    async function aiRewrite(id) {
        const el = document.getElementById(id);
        const txt = el.value;
        if(!txt) return alert("Write something first!");
        
        el.value = "Thinking..."; el.disabled = true;
        try {
            const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "Rewrite professionally: " + txt }] }] })
            });
            const res = await req.json();
            el.value = res.candidates[0].content.parts[0].text;
        } catch(e) { el.value = txt; alert("AI Error. Check Key."); }
        el.disabled = false;
    }

    // --- 2. LOGIC ---
    function calcRates() {
        const inp = +document.getElementById('inputQty').value || 0;
        let def = 0;
        document.querySelectorAll('#prodTable tbody tr').forEach(r => def += (+r.querySelector('.d-qty').value||0));
        
        const fg = Math.max(0, inp - def);
        document.getElementById('fgQty').value = fg;
        document.getElementById('fpyRate').value = inp ? ((fg/inp)*100).toFixed(1)+"%" : "0%";
    }

    function addDefectRow() {
        const id = 'act_'+Math.random().toString(36).substr(2,5);
        document.querySelector('#prodTable tbody').insertAdjacentHTML('beforeend', `
            <tr>
                <td><input type="text" class="form-control d-name"></td>
                <td><input type="number" class="form-control d-qty" value="1" oninput="calcRates()"></td>
                <td><select class="form-select d-type"><option>Process</option><option>RMD</option></select></td>
                <td><input type="text" class="form-control d-cause"></td>
                <td><div class="input-group"><input type="text" class="form-control d-action" id="${id}"><button class="ai-btn" type="button" onclick="aiRewrite('${id}')">AI</button></div></td>
                <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calcRates()">X</button></td>
            </tr>
        `);
        calcRates();
    }

    // --- 3. PREVIEW & SUBMIT ---
    function showPreview() {
        const d = {
            date: document.getElementById('date').value,
            line: document.getElementById('line').value,
            model: document.getElementById('model').value,
            input: document.getElementById('inputQty').value,
            fg: document.getElementById('fgQty').value,
            fpy: document.getElementById('fpyRate').value
        };

        let rows = "";
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            rows += `<tr><td>${r.querySelector('.d-name').value}</td><td>${r.querySelector('.d-qty').value}</td><td>${r.querySelector('.d-type').value}</td><td>${r.querySelector('.d-action').value}</td></tr>`;
        });

        document.getElementById('prevBody').innerHTML = `
            <div class="preview-content text-center">
                <img src="${LOGO_URL}" height="50" class="mb-3">
                <h4>Production Report</h4>
                <div class="row mt-3 text-start">
                    <div class="col-6"><strong>Date:</strong> ${d.date}<br><strong>Line:</strong> ${d.line}<br><strong>Model:</strong> ${d.model}</div>
                    <div class="col-6 text-end"><strong>Input:</strong> ${d.input}<br><strong>FG:</strong> ${d.fg}<br><strong class="text-primary">FPY:</strong> ${d.fpy}</div>
                </div>
                <table class="table table-sm table-striped mt-3"><thead><tr><th>Defect</th><th>Qty</th><th>Type</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('prevModal')).show();
    }

    function submitData() {
        const btn = document.getElementById('btnSubmit');
        btn.innerText = "Saving..."; btn.disabled = true;

        let defects = [];
        document.querySelectorAll('#prodTable tbody tr').forEach(r => {
            defects.push({
                name: r.querySelector('.d-name').value,
                qty: r.querySelector('.d-qty').value,
                type: r.querySelector('.d-type').value,
                cause: r.querySelector('.d-cause').value,
                action: r.querySelector('.d-action').value
            });
        });

        const id = document.getElementById('recordId').value || Date.now().toString();
        const action = document.getElementById('recordId').value ? 'edit' : 'submit';

        const payload = {
            action: action,
            id: id,
            date: document.getElementById('date').value,
            line: document.getElementById('line').value,
            model: document.getElementById('model').value,
            input: document.getElementById('inputQty').value,
            fg: document.getElementById('fgQty').value,
            fpy: document.getElementById('fpyRate').value,
            defects: JSON.stringify(defects),
            pdiDetails: { note: document.getElementById('pdiNote').value }
        };

        // Standard Text Post to avoid CORS Preflight issues in GAS
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            alert("‚úÖ " + data.message);
            location.reload();
        })
        .catch(e => {
            console.error(e);
            alert("Saved! (Note: Browser might show error due to GAS redirect, but check Sheet).");
            location.reload();
        });
    }

    // --- 4. DASHBOARD (READ) ---
    function loadDashboard() {
        // Fetch using POST with action='read' to avoid GET caching issues often seen in GAS
        fetch(API_URL, { method: "POST", body: JSON.stringify({action: 'read'}) })
        .then(r => r.json())
        .then(data => {
            GLOBAL_DATA = data;
            renderDash();
        })
        .catch(e => console.error("Load Error:", e));
    }

    function renderDash() {
        const sDate = document.getElementById('dStart').value;
        const eDate = document.getElementById('dEnd').value;
        const sLine = document.getElementById('dLine').value;

        const filtered = GLOBAL_DATA.filter(d => {
            const dt = d.date; 
            return (!sDate || dt >= sDate) && (!eDate || dt <= eDate) && (sLine === 'All' || d.line === sLine);
        });

        // Fill Table
        const tbody = document.querySelector('#crudTable tbody');
        tbody.innerHTML = "";
        let tIn=0, tFg=0, tDef=0;
        let defMap = {};

        filtered.forEach(d => {
            tIn += (+d.input||0); tFg += (+d.fg||0);
            
            // Defect Calc
            try {
                JSON.parse(d.defects).forEach(x => {
                    tDef += (+x.qty);
                    defMap[x.name] = (defMap[x.name] || 0) + (+x.qty);
                });
            } catch(e){}

            tbody.innerHTML += `
                <tr>
                    <td>${d.date}</td><td>${d.line}</td><td>${d.model}</td><td>${d.input}</td><td>${d.fg}</td><td>${d.fpy}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick="editRec('${d.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRec('${d.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        // KPIs
        document.getElementById('k-input').innerText = tIn;
        document.getElementById('k-fpy').innerText = tIn ? ((tFg/tIn)*100).toFixed(1)+"%" : "0%";
        document.getElementById('k-defects').innerText = tDef;

        // Charts
        renderCharts(filtered, defMap);
    }

    let c1, c2;
    function renderCharts(rows, defs) {
        if(c1) c1.destroy();
        c1 = new Chart(document.getElementById('chartLine'), {
            type: 'line',
            data: {
                labels: rows.map(r => r.date),
                datasets: [{ label: 'FPY %', data: rows.map(r => parseFloat(r.fpy)), borderColor: '#0d6efd', tension: 0.3 }]
            }
        });

        const sorted = Object.entries(defs).sort((a,b)=>b[1]-a[1]).slice(0,5);
        if(c2) c2.destroy();
        c2 = new Chart(document.getElementById('chartBar'), {
            type: 'bar',
            data: {
                labels: sorted.map(x=>x[0]),
                datasets: [{ label: 'Qty', data: sorted.map(x=>x[1]), backgroundColor: '#dc3545' }]
            }
        });
    }

    // --- 5. DELETE / EDIT / EXPORT ---
    function deleteRec(id) {
        if(!confirm("Delete this record?")) return;
        fetch(API_URL, { method: "POST", body: JSON.stringify({action: 'delete', id: id}) })
        .then(r => r.json()).then(d => { alert(d.message); loadDashboard(); });
    }

    function editRec(id) {
        const r = GLOBAL_DATA.find(x => x.id == id);
        if(!r) return;
        document.getElementById('recordId').value = r.id;
        document.getElementById('date').value = r.date;
        document.getElementById('line').value = r.line;
        document.getElementById('model').value = r.model;
        document.getElementById('inputQty').value = r.input;
        
        new bootstrap.Tab(document.querySelector('button[data-bs-target="#entryTab"]')).show();
        calcRates();
        alert("Record Loaded! Edit and Submit.");
    }

    function exportData() {
        const ws = XLSX.utils.json_to_sheet(GLOBAL_DATA);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, "Califonix_Report.xlsx");
    }

    // Helpers
    function togglePDI() { document.getElementById('pdiSection').classList.toggle('hidden', !document.getElementById('pdiToggle').checked); }
    function calcPDI() { document.getElementById('pdiFail').value = (+document.getElementById('pdiOffer').value) - (+document.getElementById('pdiPass').value); }
    function resetForm() { document.getElementById('mainForm').reset(); document.querySelector('#prodTable tbody').innerHTML=''; }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
