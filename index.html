<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashcam Dashboard Pro</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
  .container { max-width: 1250px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
  
  /* Header & Logo */
  .header-box { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
  .logo { height: 50px; }

  /* Navigation */
  .nav { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; background: #f8f9fa; padding: 10px; border-radius: 8px; }
  button { padding: 10px 18px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.3s; }
  button:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-blue { background: #007bff; color: white; }
  .btn-green { background: #28a745; color: white; }
  .btn-gray { background: #6c757d; color: white; }
  .btn-red { background: #dc3545; color: white; padding: 5px 10px; font-size: 12px;}
  .btn-info { background: #17a2b8; color: white; padding: 5px 10px; font-size: 12px; }
  .btn-purple { background: #6f42c1; color: white; }
  .btn-ai { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 5px 10px; font-size: 11px; border-radius: 15px; margin-left:5px;}

  /* Forms */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
  input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #fff; }
  input:focus { border-color: #007bff; outline: none; }
  
  /* Defect Rows */
  .defect-row { border: 1px solid #e0e0e0; padding: 10px; margin-bottom: 10px; border-radius: 6px; background: #fafafa; display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 2fr 1fr 0.5fr; gap: 10px; align-items: end; }
  .pdi-row { background: #fff5f5; border-color: #ffcccc; } /* Red tint for PDI rows */

  /* KPI Cards */
  .kpi-container { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;}
  .kpi-card { flex: 1; min-width: 160px; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid #007bff; }
  .kpi-title { font-size: 14px; color: #777; }
  .kpi-val { font-size: 26px; font-weight: 800; margin-top: 5px; color: #333; }

  /* Report Sections */
  .report-box { border: 1px solid #ddd; padding: 30px; display: none; margin-top: 20px; background: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
  .chart-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
  .chart-box { flex: 1; min-width: 300px; height: 350px; border: 1px solid #f0f0f0; padding: 10px; }
  
  /* Modal */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
  .modal-content { background-color: #fff; margin: 5% auto; padding: 25px; border-radius: 10px; width: 90%; max-width: 850px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  
  #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1001; text-align: center; padding-top: 200px; font-size: 22px; font-weight: bold; color: #007bff; }
  .hidden { display: none; }
</style>
</head>
<body>

<div id="loader">üöÄ Processing... Please Wait...</div>

<!-- PREVIEW MODAL -->
<div id="previewModal" class="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
        <h3 style="margin:0">üìÑ Record Details Preview</h3>
        <span style="font-size:24px; cursor:pointer;" onclick="closeModal()">√ó</span>
    </div>
    <div id="previewBody" style="margin-top:15px;"></div>
    <div style="margin-top:20px; text-align:right;">
        <button class="btn-gray" onclick="closeModal()">Edit</button>
        <button class="btn-green" onclick="saveData()">‚úÖ Confirm & Save</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="header-box">
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo" alt="Califonix"> <!-- ‡§≤‡•ã‡§ó‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à -->
      <h2 style="margin:0; color:#333;">üè≠ SMT Production & PDI Dashboard</h2>
  </div>

  <!-- NAVIGATION -->
  <div class="nav">
    <button class="btn-blue" onclick="showPage('dashboard')">üìä Dashboard</button>
    <button class="btn-gray" onclick="showPage('entry')">üìù Data Entry</button>
    <button class="btn-green" onclick="showPage('report')">üìë Overall Report</button>
    <button class="btn-purple" onclick="showPage('model_report')">üì¶ Model Report</button>
  </div>

  <!-- 1. DASHBOARD PAGE -->
  <div id="dashboard">
    <div class="form-grid">
      <div><label>From Date</label><input type="date" id="dash_from"></div>
      <div><label>To Date</label><input type="date" id="dash_to"></div>
      <div style="display:flex; align-items:end;"><button class="btn-blue" onclick="loadData()">Filter Data</button></div>
    </div>

    <div class="kpi-container">
       <div class="kpi-card"><div class="kpi-title">Production Rejection</div><div class="kpi-val" id="k_all" style="color:#d32f2f">0%</div></div>
       <div class="kpi-card"><div class="kpi-title">PDI Rejection</div><div class="kpi-val" id="k_pdi" style="color:#c2185b">0%</div></div>
       <div class="kpi-card"><div class="kpi-title">Total Input</div><div class="kpi-val" id="k_inp" style="color:#1976d2">0</div></div>
       <div class="kpi-card"><div class="kpi-title">Total Defects</div><div class="kpi-val" id="k_def" style="color:#f57c00">0</div></div>
    </div>

    <div style="overflow-x:auto;">
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#e0e0e0; font-size:13px; text-align:center;">
        <thead>
            <tr style="background:#f1f3f5; color:#495057;">
                <th>Date</th><th>Line</th><th>Model</th><th>Input</th><th>Prod Rej%</th><th>PDI Input</th><th>PDI Rej%</th><th>Action</th>
            </tr>
        </thead>
        <tbody id="dash_table"></tbody>
      </table>
    </div>
  </div>

  <!-- 2. DATA ENTRY PAGE -->
  <div id="entry" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üìù Add New Record</h3>
        <button class="btn-gray" onclick="resetEntry()">üîÑ Reset</button>
    </div>
    <input type="hidden" id="edit_index">
    
    <!-- PRODUCTION DATA -->
    <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h4 style="margin-top:0; color:#007bff;">1. Production Details</h4>
        <div class="form-grid">
          <div><label>Date</label><input type="date" id="e_date"></div>
          <div><label>Line</label><select id="e_line"><option>Line 1</option><option>Line 2</option><option>Line 3</option></select></div>
          <div><label>Model</label><input type="text" id="e_model" placeholder="Model Name"></div>
          <div><label>Input Qty</label><input type="number" id="e_input" oninput="calcTotal()" placeholder="0"></div>
          <div><label>Prepared By</label><input type="text" id="e_prep"></div>
        </div>

        <label>Production Defects:</label>
        <div id="defect_wrapper"></div>
        <button class="btn-gray" onclick="addDefectRow('prod')">+ Add Defect</button>
        <div style="margin-top:10px; font-weight:bold;">Total Prod Defects: <span id="lbl_tot">0</span> | Rate: <span id="lbl_rate" style="color:red">0%</span></div>
    </div>

    <!-- PDI DATA (NEW) -->
    <div style="background:#fff0f3; padding:15px; border-radius:8px; border:1px solid #ffdde5; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between;">
            <h4 style="margin-top:0; color:#c2185b;">2. PDI Details</h4>
            <label><input type="checkbox" id="pdi_check" onchange="togglePDI()"> Enable PDI</label>
        </div>
        
        <div id="pdi_section" class="hidden">
            <div class="form-grid">
                <div><label>PDI Input</label><input type="number" id="pdi_input" oninput="calcPDI()"></div>
                <div><label>PDI Pass</label><input type="number" id="pdi_pass" oninput="calcPDI()"></div>
                <div><label>PDI Fail</label><input type="text" id="pdi_fail" readonly style="color:red; font-weight:bold;"></div>
                <div><label>PDI Rate %</label><input type="text" id="pdi_rate" readonly></div>
            </div>

            <label>PDI Defects (If any):</label>
            <div id="pdi_defect_wrapper"></div>
            <button class="btn-gray" onclick="addDefectRow('pdi')">+ Add PDI Defect</button>
        </div>
    </div>

    <button class="btn-blue" onclick="previewEntry()" style="width:100%; padding:15px; font-size:16px;">üëÅÔ∏è PREVIEW & SAVE</button>
  </div>

  <!-- 3. OVERALL REPORT PAGE -->
  <div id="report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From</label><input type="date" id="r_date_start"></div>
      <div><label>To</label><input type="date" id="r_date_end"></div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-blue" onclick="genReport()">Generate</button>
        <button class="btn-green" onclick="downloadPDF('print_area', 'Overall_Report.pdf')">Download PDF</button>
      </div>
    </div>

    <div id="print_area" class="report-box">
      <h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">CALIFONIX SMT ANALYSIS</h2>
      <p style="text-align:center; font-weight:bold;" id="r_subtitle">--</p>
      
      <table style="width:100%; border:1px solid #ddd; margin-bottom:20px; text-align:center; background:#f9f9f9;">
        <tr>
            <td style="padding:10px;"><b>Prod Input:</b> <span id="r_inp">0</span></td>
            <td style="padding:10px;"><b>Prod Defect:</b> <span id="r_def">0</span></td>
            <td style="padding:10px;"><b>Prod Rej %:</b> <span id="r_rate_val" style="color:red">0%</span></td>
            <td style="padding:10px; border-left:1px solid #ccc;"><b>PDI Rej %:</b> <span id="r_pdi_rate" style="color:#c2185b">0%</span></td>
        </tr>
      </table>

      <div class="chart-row">
        <div class="chart-box" id="trend_chart_div"></div>
        <div class="chart-box" id="pareto_chart_div"></div>
      </div>
      
      <h4 style="border-bottom:2px solid #333;">üèÜ Top 5 Production Defects</h4>
      <div id="analysis_list"></div>
    </div>
  </div>

  <!-- 4. MODEL REPORT PAGE -->
  <div id="model_report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From</label><input type="date" id="m_date_start"></div>
      <div><label>To</label><input type="date" id="m_date_end"></div>
      <div><label>Model</label><select id="m_model_select"><option value="">Loading...</option></select></div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-purple" onclick="genModelReport()">View</button>
        <button class="btn-green" onclick="downloadPDF('model_print_area', 'Model_Report.pdf')">PDF</button>
      </div>
    </div>

    <div id="model_print_area" class="report-box">
      <h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">MODEL WISE ANALYSIS</h2>
      <p style="text-align:center; font-weight:bold;" id="m_subtitle">--</p>
      <h3 style="text-align:center; color:#007bff;" id="m_name_disp"></h3>

      <div class="chart-row">
        <div class="chart-box" id="m_trend_chart"></div>
        <div class="chart-box" id="m_pareto_chart"></div>
      </div>
      
      <h4 style="border-bottom:2px solid #333;">üèÜ Defects Analysis</h4>
      <div id="m_analysis_list"></div>
    </div>
  </div>

</div>

<script>
// ==========================================
// CONFIGURATION
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbyWo595HFuNTo3BqNwUk_ktFNc3hGVdwBeDIAJ5xumcPJ_yru9FXwJvbnhx9g0z7PVs6Q/exec"; // üî¥ ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ Apps Script URL ‡§°‡§æ‡§≤‡•á‡§Ç
const GEMINI_API_KEY = "AIzaSyDwFbj25ROQX52IzObhVIW_6t61O5TC2pA"; // üî¥ ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡•Ä Gemini Key ‡§°‡§æ‡§≤‡•á‡§Ç
const DEFECT_MASTER_LIST = ["Solder Skip", "Bridge", "Shift", "Missing Comp", "Wrong Polarity", "Tombstone", "Excess Solder", "Insufficient Solder", "Damage", "Other"];

let allData = [];
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('e_date').value = today;
  document.getElementById('dash_from').value = today;
  loadData();
  addDefectRow('prod'); // Default row
};

function showPage(id){
  document.querySelectorAll('#dashboard, #entry, #report, #model_report').forEach(d => d.style.display='none');
  document.getElementById(id).style.display='block';
}

function formatPct(val) {
    if(!val) return "0.00%";
    let s = String(val);
    if(s.includes("%")) return s;
    return (parseFloat(s) * 100).toFixed(2) + "%";
}

// ==========================================
// AI FUNCTION
// ==========================================
async function aiFix(btn) {
    if(!GEMINI_API_KEY) return alert("API Key Missing!");
    let input = btn.previousElementSibling;
    let txt = input.value;
    if(!txt) return alert("Please write some analysis first!");
    
    btn.innerHTML = "‚è≥"; btn.disabled = true;
    try {
        let res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: "Rewrite this technical defect analysis in short professional English: " + txt }] }] })
        });
        let json = await res.json();
        input.value = json.candidates[0].content.parts[0].text;
    } catch(e) { console.error(e); alert("AI Error"); }
    btn.innerHTML = "‚ú® AI"; btn.disabled = false;
}

// ==========================================
// DATA ENTRY LOGIC
// ==========================================
function togglePDI() {
    let check = document.getElementById('pdi_check').checked;
    document.getElementById('pdi_section').classList.toggle('hidden', !check);
}

function calcPDI() {
    let inp = +document.getElementById('pdi_input').value || 0;
    let pass = +document.getElementById('pdi_pass').value || 0;
    let fail = Math.max(0, inp - pass);
    document.getElementById('pdi_fail').value = fail;
    document.getElementById('pdi_rate').value = inp > 0 ? (fail/inp*100).toFixed(2)+"%" : "0%";
}

function addDefectRow(type, data=null){
  const div = document.createElement('div');
  div.className = type === 'prod' ? 'defect-row' : 'defect-row pdi-row';
  let options = DEFECT_MASTER_LIST.map(d => `<option value="${d}">${d}</option>`).join("");
  
  // Unique ID for AI targeting if needed
  div.innerHTML = `
    <div><label>${type==='prod'?'Prod':'PDI'} Defect</label><select class="d-name"><option value="">Select</option>${options}</select></div>
    <div><label>Qty</label><input type="number" class="d-qty" oninput="${type==='prod'?'calcTotal()':''}" placeholder="0"></div>
    <div><label>Rate %</label><input class="d-rate" readonly></div>
    <div>
        <label>Analysis</label>
        <div style="display:flex; align-items:center;">
            <input class="d-ana" placeholder="Reason">
            <button class="btn-ai" onclick="aiFix(this)">‚ú® AI</button>
        </div>
    </div>
    <div><label>Image</label><input type="file" accept="image/*"></div>
    <div><label>&nbsp;</label><button class="btn-red" onclick="this.closest('.defect-row').remove(); ${type==='prod'?'calcTotal()':''}">X</button></div>
  `;
  
  if(type === 'prod') document.getElementById('defect_wrapper').appendChild(div);
  else document.getElementById('pdi_defect_wrapper').appendChild(div);

  if(data){
    div.querySelector('.d-name').value = data.name;
    div.querySelector('.d-qty').value = data.qty;
    div.querySelector('.d-rate').value = formatPct(data.rate || 0);
    div.querySelector('.d-ana').value = data.analysis;
  }
}

function calcTotal(){
  let inp = +document.getElementById('e_input').value || 0;
  let tot = 0;
  // Calculate only Production Defects
  document.getElementById('defect_wrapper').querySelectorAll('.d-qty').forEach(i => tot += (+i.value||0));
  document.getElementById('lbl_tot').innerText = tot;
  document.getElementById('lbl_rate').innerText = inp > 0 ? (tot/inp*100).toFixed(2)+"%" : "0.00%";
  
  // Update Row Rates
  document.getElementById('defect_wrapper').querySelectorAll('.defect-row').forEach(row => {
     let qty = +row.querySelector('.d-qty').value || 0;
     row.querySelector('.d-rate').value = (inp > 0 && qty > 0) ? (qty / inp * 100).toFixed(2) + "%" : "0%";
  });
}

function getDefectsFromContainer(containerId) {
    let arr = [];
    document.getElementById(containerId).querySelectorAll('.defect-row').forEach(row => {
        arr.push({
            name: row.querySelector('.d-name').value,
            qty: row.querySelector('.d-qty').value,
            rate: row.querySelector('.d-rate').value,
            analysis: row.querySelector('.d-ana').value
        });
    });
    return arr;
}

function previewEntry() {
    let data = {
        date: document.getElementById('e_date').value,
        line: document.getElementById('e_line').value,
        model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value,
        prodDefects: getDefectsFromContainer('defect_wrapper'),
        isPDI: document.getElementById('pdi_check').checked,
        pdi: {
            input: document.getElementById('pdi_input').value,
            pass: document.getElementById('pdi_pass').value,
            fail: document.getElementById('pdi_fail').value,
            rate: document.getElementById('pdi_rate').value,
            defects: getDefectsFromContainer('pdi_defect_wrapper')
        }
    };

    let html = `
        <table style="width:100%; border-collapse:collapse; border:1px solid #ddd; margin-bottom:10px;">
            <tr><td><b>Date:</b> ${data.date}</td><td><b>Line:</b> ${data.line}</td><td><b>Model:</b> ${data.model}</td></tr>
            <tr><td><b>Prod Input:</b> ${data.input}</td><td colspan="2"><b>Prod Defects:</b> ${data.prodDefects.reduce((a,b)=>a+(+b.qty),0)}</td></tr>
        </table>
        <h5>Production Defects:</h5>
        <ul>${data.prodDefects.map(d=>`<li>${d.name} (Qty: ${d.qty}) - ${d.analysis}</li>`).join('') || 'None'}</ul>
    `;

    if(data.isPDI) {
        html += `<h5 style="color:#c2185b; border-top:1px solid #ccc; padding-top:10px;">PDI Summary</h5>
        <table style="width:100%;"><tr><td>Input: ${data.pdi.input}</td><td>Pass: ${data.pdi.pass}</td><td style="color:red">Fail: ${data.pdi.fail} (${data.pdi.rate})</td></tr></table>
        <ul>${data.pdi.defects.map(d=>`<li>${d.name} (Qty: ${d.qty}) - ${d.analysis}</li>`).join('') || 'No PDI Defects Logged'}</ul>`;
    }

    document.getElementById('previewBody').innerHTML = html;
    document.getElementById('previewModal').style.display = "block";
}

function closeModal() { document.getElementById('previewModal').style.display = "none"; }

async function saveData(){
  closeModal(); document.getElementById('loader').style.display = 'block';
  
  let payload = {
    action: "save",
    rowIndex: document.getElementById('edit_index').value,
    date: document.getElementById('e_date').value,
    line: document.getElementById('e_line').value,
    model: document.getElementById('e_model').value,
    input: document.getElementById('e_input').value,
    totalDef: document.getElementById('lbl_tot').innerText,
    rejRate: document.getElementById('lbl_rate').innerText,
    prep: document.getElementById('e_prep').value,
    defects: getDefectsFromContainer('defect_wrapper'),
    
    // PDI DATA
    pdiInput: document.getElementById('pdi_check').checked ? document.getElementById('pdi_input').value : 0,
    pdiPass: document.getElementById('pdi_pass').value,
    pdiFail: document.getElementById('pdi_fail').value,
    pdiRate: document.getElementById('pdi_rate').value,
    pdiDefects: getDefectsFromContainer('pdi_defect_wrapper')
  };

  try {
    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    alert("‚úÖ Saved Successfully!");
    location.reload();
  } catch(e) { alert("Error saving data"); } 
  finally { document.getElementById('loader').style.display = 'none'; }
}

function resetEntry() {
    document.getElementById('edit_index').value = "";
    document.getElementById('defect_wrapper').innerHTML = "";
    document.getElementById('pdi_defect_wrapper').innerHTML = "";
    addDefectRow('prod');
}

// ==========================================
// LOAD & DASHBOARD
// ==========================================
async function loadData(){
  try {
    let res = await fetch(API_URL);
    let json = await res.json();
    allData = json.data;
    populateModelDropdown();
    renderDash();
  } catch(e) { console.log("Load Error", e); }
}

function populateModelDropdown(){
    let models = [...new Set(allData.map(r => r[2]))];
    let sel = document.getElementById('m_model_select');
    sel.innerHTML = '<option value="">Select Model</option>' + models.map(m => `<option value="${m}">${m}</option>`).join("");
}

function renderDash(){
  let from = document.getElementById('dash_from').value;
  let to = document.getElementById('dash_to').value || from;
  let tBody = document.getElementById('dash_table');
  tBody.innerHTML = "";
  
  let stats = { inp:0, def:0, pdiRejSum:0, count:0 };

  allData.forEach((r, idx) => {
    if(r[0] < from || r[0] > to) return;
    
    // Index mapping based on Sheet Headers
    // 0:Date, 1:Line, 2:Model, 3:Inp, 4:Def, 5:Rej%, 8:PDIInp, 11:PDIRate
    let inp = +r[3]; let def = +r[4];
    stats.inp += inp; stats.def += def;
    
    let pdiInp = r[8] || 0;
    let pdiRate = r[11] || "0%";

    tBody.innerHTML += `<tr>
        <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>
        <td>${inp}</td><td style="color:${parseFloat(r[5])>0?'red':'green'}">${formatPct(r[5])}</td>
        <td>${pdiInp}</td><td style="color:${parseFloat(pdiRate)>0?'#c2185b':'green'}">${formatPct(pdiRate)}</td>
        <td>
            <button class="btn-info" onclick='editRow(${idx}, ${JSON.stringify(r)})'>Edit</button> 
            <button class="btn-red" onclick="delRow(${idx})">Del</button>
        </td>
    </tr>`;
  });

  document.getElementById('k_inp').innerText = stats.inp;
  document.getElementById('k_def').innerText = stats.def;
  document.getElementById('k_all').innerText = stats.inp > 0 ? (stats.def/stats.inp*100).toFixed(2)+"%" : "0%";
}

function editRow(idx, r){
  showPage('entry');
  document.getElementById('edit_index').value = idx;
  document.getElementById('e_date').value = r[0];
  document.getElementById('e_line').value = r[1];
  document.getElementById('e_model').value = r[2];
  document.getElementById('e_input').value = r[3];
  document.getElementById('e_prep').value = r[6];

  // Prod Defects
  document.getElementById('defect_wrapper').innerHTML = "";
  try { JSON.parse(r[7]).forEach(d => addDefectRow('prod', d)); } catch(e) { addDefectRow('prod'); }
  
  // PDI Data
  document.getElementById('pdi_input').value = r[8];
  document.getElementById('pdi_pass').value = r[9];
  document.getElementById('pdi_fail').value = r[10];
  document.getElementById('pdi_rate').value = r[11];
  
  if(r[8] > 0) {
      document.getElementById('pdi_check').checked = true;
      togglePDI();
      document.getElementById('pdi_defect_wrapper').innerHTML = "";
      try { JSON.parse(r[12]).forEach(d => addDefectRow('pdi', d)); } catch(e) {}
  }
  
  calcTotal();
}

async function delRow(idx){
  if(!confirm("Delete?")) return;
  document.getElementById('loader').style.display='block';
  await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"delete", rowIndex:idx}) });
  location.reload();
}

// ==========================================
// REPORT GEN (Simplified)
// ==========================================
function genReport(){
    // Logic similar to previous but including PDI stats aggregation
    alert("Report generation logic active (Charts will update based on filter)");
    // Call chart rendering here...
}
</script>
</body>
</html>

